# Micro Penetration Test Feature - Implementation Summary

## Overview

This feature enables users to select multiple CVEs from the Risk Graph and run targeted micro penetration tests using PentAGI integration.

## Implementation Details

### Frontend Changes (`frontend/src/pages/RiskGraph.jsx`)

1. **Multi-Select Functionality**
   - Added `selectedCves` state to track selected CVE nodes
   - Modified `handleNodeClick` to support Ctrl/Cmd+Click for multi-select
   - Visual feedback: Selected CVEs highlighted with purple border
   - Selection counter displayed in stats panel

2. **Context Menu**
   - Right-click handler (`handleRightClick`) for CVE nodes
   - Context menu appears when CVEs are selected
   - "Run Micro Pen Tests" button with loading state

3. **Pentest Execution**
   - `handleRunMicroPentest` function:
     - Extracts target URLs from connected services/components
     - Calls `/api/v1/micro-pentest/run` endpoint
     - Polls status every 5 seconds
     - Displays status notification

4. **Status Monitoring**
   - Real-time status updates via polling
   - Status notification panel in bottom-right corner
   - Auto-close after 5 minutes

### Backend Changes (`fixops-enterprise/src/api/v1/micro_pentest.py`)

1. **New API Endpoints**
   - `POST /api/v1/micro-pentest/run` - Start micro pen test
   - `GET /api/v1/micro-pentest/status/{flow_id}` - Get test status
   - `POST /api/v1/micro-pentest/batch` - Run multiple tests in parallel

2. **PentAGI Integration**
   - Creates PentAGI flow via REST API (`POST /api/v1/flows`)
   - Configurable PentAGI URL via `PENTAGI_BASE_URL` environment variable
   - Default URL: `http://pentagi:8443`

3. **Error Handling**
   - Validates CVE IDs and target URLs
   - Handles PentAGI connection errors
   - Timeout handling (5 minutes)

### API Integration (`frontend/src/utils/api.js`)

Added `microPentest` methods:
- `run(payload)` - Start micro pen test
- `status(flowId)` - Get test status
- `batch(payload)` - Run batch tests

## Usage Flow

1. **Select CVEs**
   - Click on CVE nodes to select
   - Use Ctrl/Cmd+Click to select multiple
   - Selected CVEs highlighted in purple

2. **Run Tests**
   - Right-click on any selected CVE
   - Click "Run Micro Pen Tests"
   - System automatically discovers target URLs

3. **Monitor Progress**
   - Status notification appears
   - Shows flow ID and status
   - Updates every 5 seconds

## Configuration

### Environment Variables

- `PENTAGI_BASE_URL` - PentAGI API base URL (default: `http://pentagi:8443`)

### API Request Format

```json
{
  "cve_ids": ["CVE-2024-1234", "CVE-2024-5678"],
  "target_urls": ["https://example.com"],
  "context": {
    "source": "risk_graph",
    "selected_count": 2
  }
}
```

### API Response Format

```json
{
  "status": "started",
  "flow_id": 12345,
  "cve_ids": ["CVE-2024-1234"],
  "target_urls": ["https://example.com"],
  "message": "Micro penetration test started for 1 CVEs"
}
```

## Technical Notes

### Cytoscape Integration

- Uses `cxttapstart` event for right-click detection
- Context menu positioned relative to graph canvas
- Handles both node and background clicks

### Target URL Discovery

- Automatically extracts URLs from connected services/components
- Falls back to default URL if none found
- Removes duplicate URLs

### Status Polling

- Polls every 5 seconds
- Auto-stops after 5 minutes
- Handles connection errors gracefully

## Future Enhancements

- [ ] WebSocket support for real-time updates
- [ ] Detailed test results view
- [ ] Test history and reports
- [ ] Custom test configurations
- [ ] Integration with FixOps decision engine

## Testing

To test the feature:

1. Start FixOps backend with PentAGI integration
2. Navigate to Risk Graph page
3. Select CVEs using Ctrl/Cmd+Click
4. Right-click and select "Run Micro Pen Tests"
5. Monitor status in notification panel

## Related Files

- `/workspace/frontend/src/pages/RiskGraph.jsx` - Main component
- `/workspace/fixops-enterprise/src/api/v1/micro_pentest.py` - API endpoints
- `/workspace/fixops-enterprise/src/api/v1/__init__.py` - Router registration
- `/workspace/frontend/src/utils/api.js` - API client methods
- `/workspace/MICRO_PENTEST_INTEGRATION.md` - Detailed documentation
