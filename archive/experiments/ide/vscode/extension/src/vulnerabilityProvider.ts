/**
 * Vulnerability Tree View Provider for VS Code
 */

import * as vscode from 'vscode';
import { FixOpsClient, Vulnerability, ScanResults } from './fixopsClient';

export class VulnerabilityProvider implements vscode.TreeDataProvider<VulnerabilityItem> {
    private _onDidChangeTreeData: vscode.EventEmitter<VulnerabilityItem | undefined | null | void> = new vscode.EventEmitter<VulnerabilityItem | undefined | null | void>();
    readonly onDidChangeTreeData: vscode.Event<VulnerabilityItem | undefined | null | void> = this._onDidChangeTreeData.event;

    private results: ScanResults | null = null;

    constructor(private client: FixOpsClient) {}

    updateResults(results: ScanResults) {
        this.results = results;
        this._onDidChangeTreeData.fire();
    }

    refresh(): void {
        this._onDidChangeTreeData.fire();
    }

    getTreeItem(element: VulnerabilityItem): vscode.TreeItem {
        return element;
    }

    getChildren(element?: VulnerabilityItem): Thenable<VulnerabilityItem[]> {
        if (!this.results) {
            return Promise.resolve([]);
        }

        if (!element) {
            // Root level - show summary
            return Promise.resolve([
                new VulnerabilityItem(
                    `Critical: ${this.results.summary.critical}`,
                    vscode.TreeItemCollapsibleState.None,
                    'critical'
                ),
                new VulnerabilityItem(
                    `High: ${this.results.summary.high}`,
                    vscode.TreeItemCollapsibleState.None,
                    'high'
                ),
                new VulnerabilityItem(
                    `Medium: ${this.results.summary.medium}`,
                    vscode.TreeItemCollapsibleState.None,
                    'medium'
                ),
                new VulnerabilityItem(
                    `Low: ${this.results.summary.low}`,
                    vscode.TreeItemCollapsibleState.None,
                    'low'
                ),
            ]);
        }

        // Show vulnerabilities by severity
        const severity = element.severity;
        const vulns = this.results.vulnerabilities.filter(v => v.severity === severity);
        
        return Promise.resolve(
            vulns.map(v => new VulnerabilityItem(
                `${v.file}:${v.line} - ${v.message}`,
                vscode.TreeItemCollapsibleState.None,
                severity,
                v
            ))
        );
    }
}

class VulnerabilityItem extends vscode.TreeItem {
    constructor(
        public readonly label: string,
        public readonly collapsibleState: vscode.TreeItemCollapsibleState,
        public readonly severity?: string,
        public readonly vulnerability?: Vulnerability
    ) {
        super(label, collapsibleState);
        
        if (vulnerability) {
            this.command = {
                command: 'vscode.open',
                title: 'Open File',
                arguments: [
                    vscode.Uri.file(vulnerability.file),
                    { selection: new vscode.Range(vulnerability.line - 1, 0, vulnerability.line - 1, 0) }
                ],
            };
            
            this.contextValue = 'vulnerability';
            this.tooltip = vulnerability.message;
        }
        
        // Set icon based on severity
        if (severity) {
            switch (severity) {
                case 'critical':
                    this.iconPath = new vscode.ThemeIcon('error', new vscode.ThemeColor('errorForeground'));
                    break;
                case 'high':
                    this.iconPath = new vscode.ThemeIcon('warning', new vscode.ThemeColor('editorWarning.foreground'));
                    break;
                case 'medium':
                    this.iconPath = new vscode.ThemeIcon('info', new vscode.ThemeColor('editorInfo.foreground'));
                    break;
                case 'low':
                    this.iconPath = new vscode.ThemeIcon('circle-outline');
                    break;
            }
        }
    }
}
