#!/usr/bin/env python3
"""Generate a professional HTML penetration test report from ALdeci micropentest results."""

import json
import os
import sys
import time
import webbrowser
from datetime import datetime, timezone
from pathlib import Path

import requests

BASE = "http://localhost:8000"
HEADERS = {"X-API-Key": "test-token-123", "Content-Type": "application/json"}
OUTPUT_DIR = Path(".fixops_data")
REPORT_FILE = OUTPUT_DIR / "pentest_report.html"


def run_pentest() -> dict:
    """Run micropentest and return JSON response."""
    cves = [
        "CVE-2021-44228", "CVE-2023-44487", "CVE-2024-3094", "CVE-2022-22965",
        "CVE-2023-4966", "CVE-2014-0160", "CVE-2017-5638", "CVE-2023-27997",
        "CVE-2023-20198", "CVE-2024-21887", "CVE-2023-0669", "CVE-2023-27350",
        "CVE-2024-1709",
    ]
    targets = [
        "https://httpbin.org", "https://example.com",
        "https://www.google.com", "https://github.com",
    ]
    payload = {
        "cve_ids": cves,
        "target_urls": targets,
        "context": {"scan_type": "advanced", "environment": "production"},
    }
    print("[*] Running micropentest (this may take ~2-3 minutes)...")
    t0 = time.time()
    resp = requests.post(f"{BASE}/api/v1/micro-pentest/run", json=payload, headers=HEADERS, timeout=600)
    elapsed = time.time() - t0
    print(f"[+] Completed in {elapsed:.1f}s (HTTP {resp.status_code})")
    resp.raise_for_status()
    # Cache results
    cache = OUTPUT_DIR / "pentest_report_data.json"
    cache.write_text(json.dumps(resp.json(), indent=2))
    return resp.json()


def load_cached() -> dict | None:
    """Load cached results if available."""
    cache = OUTPUT_DIR / "pentest_report_data.json"
    if cache.exists():
        return json.loads(cache.read_text())
    return None


# ‚îÄ‚îÄ‚îÄ Severity helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
SEV_COLORS = {
    "critical": "#dc2626", "high": "#ea580c", "medium": "#d97706",
    "low": "#2563eb", "info": "#6b7280", "unknown": "#9ca3af",
}
SEV_ORDER = ["critical", "high", "medium", "low", "info", "unknown"]


def sev_badge(sev: str) -> str:
    c = SEV_COLORS.get(sev, "#9ca3af")
    return f'<span class="badge" style="background:{c}">{sev.upper()}</span>'


def pct_bar(pct: float, color: str = "#22c55e") -> str:
    bg = "#dc2626" if pct < 60 else "#d97706" if pct < 85 else "#22c55e"
    return (
        f'<div class="pct-bar"><div class="pct-fill" style="width:{pct}%;background:{bg}">'
        f'{pct:.1f}%</div></div>'
    )


def risk_gauge(score: float, level: str) -> str:
    angle = score / 10 * 180
    c = SEV_COLORS.get(level, "#d97706")
    return f"""<div class="gauge-wrap">
      <div class="gauge"><div class="gauge-fill" style="transform:rotate({angle}deg);border-color:{c}"></div>
      <div class="gauge-cover"><span class="gauge-val">{score}</span><span class="gauge-max">/10</span>
      <div class="gauge-label">{level.upper()}</div></div></div></div>"""


# ‚îÄ‚îÄ‚îÄ HTML skeleton ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def build_html(data: dict) -> str:
    meta = data.get("scan_metadata") or {}
    cve_results = data.get("cve_results") or []
    findings = data.get("findings") or []
    summary = meta.get("executive_summary") or {}
    risk = meta.get("risk_score") or {}
    compliance = meta.get("compliance") or {}
    mitre = meta.get("mitre_techniques") or []
    chains = meta.get("attack_chains") or []
    fp = meta.get("false_positive_analysis") or {}
    poc = meta.get("poc_commands") or []
    now = datetime.now(timezone.utc).strftime("%Y-%m-%d %H:%M:%S UTC")

    # Compute severity distribution
    sev_dist = {}
    for f in findings:
        s = f.get("severity", "unknown")
        sev_dist[s] = sev_dist.get(s, 0) + 1

    # Per-target summary
    target_map: dict[str, list] = {}
    for f in findings:
        t = f.get("target", "unknown")
        target_map.setdefault(t, []).append(f)

    ai = meta.get("ai_analysis") or {}

    # Split cve_results: verified exploits (promoted findings) vs CVE assessments
    verified_exploits = [r for r in cve_results if r.get("finding_type") == "verified_exploit"]
    cve_only = [r for r in cve_results if r.get("finding_type") != "verified_exploit"]

    # Build sections ‚Äî verified exploits + PoCs first (actionable), CVE matrix later
    parts = [_css(), _cover(data, now, meta), _exec_summary(summary, risk, meta)]
    parts.append(_verified_exploits_section(verified_exploits))  # NEW: right after summary
    parts.append(_poc_section(poc))  # PoCs moved up ‚Äî actionable
    parts.append(_severity_table(sev_dist, findings))
    parts.append(_target_breakdown(target_map))
    parts.append(_cve_matrix(cve_only))  # Only CVE-specific results, not promoted exploits
    parts.append(_mitre_section(mitre))
    parts.append(_chains_section(chains))
    parts.append(_compliance_section(compliance))
    parts.append(_fp_section(fp))
    parts.append(_ai_transparency_section(ai, meta))
    parts.append(_methodology(meta))
    parts.append(_footer(now, meta))

    return "\n".join(parts)


# ‚îÄ‚îÄ‚îÄ Section generators ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

def _css():
    return """<!DOCTYPE html><html lang="en"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ALdeci Penetration Test Report</title>
<style>
:root{--bg:#0f172a;--card:#1e293b;--border:#334155;--txt:#e2e8f0;--dim:#94a3b8;--accent:#3b82f6}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--txt);line-height:1.6}
.container{max-width:1100px;margin:0 auto;padding:20px 30px}
h1{font-size:2.2rem;font-weight:700;margin-bottom:4px}
h2{font-size:1.5rem;font-weight:600;margin:40px 0 16px;padding-bottom:8px;border-bottom:2px solid var(--accent);color:#fff}
h3{font-size:1.1rem;font-weight:600;margin:20px 0 8px;color:#cbd5e1}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:24px;margin-bottom:20px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.grid4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px}
.stat{text-align:center;padding:16px;background:var(--bg);border-radius:10px}
.stat .num{font-size:2rem;font-weight:700;color:#fff}
.stat .lbl{font-size:.75rem;text-transform:uppercase;color:var(--dim);letter-spacing:.05em}
.badge{display:inline-block;padding:2px 10px;border-radius:20px;font-size:.7rem;font-weight:700;color:#fff;text-transform:uppercase;letter-spacing:.04em}
table{width:100%;border-collapse:collapse;font-size:.85rem}
th{text-align:left;padding:10px 12px;background:var(--bg);color:var(--dim);font-weight:600;text-transform:uppercase;font-size:.7rem;letter-spacing:.05em}
td{padding:10px 12px;border-bottom:1px solid var(--border)}
tr:hover td{background:rgba(59,130,246,.04)}
.pct-bar{background:var(--bg);border-radius:6px;height:22px;overflow:hidden;position:relative}
.pct-fill{height:100%;border-radius:6px;display:flex;align-items:center;justify-content:flex-end;padding-right:8px;font-size:.7rem;font-weight:700;color:#fff;min-width:40px;transition:width .4s}
.gauge-wrap{display:flex;justify-content:center;padding:10px 0}
.gauge{width:180px;height:90px;position:relative;overflow:hidden}
.gauge::before{content:'';display:block;width:180px;height:90px;border-radius:90px 90px 0 0;background:var(--bg);border:8px solid var(--border);border-bottom:none}
.gauge-fill{position:absolute;bottom:0;left:0;width:180px;height:90px;border-radius:90px 90px 0 0;border:8px solid;border-bottom:none;transform-origin:center bottom;transform:rotate(0deg);transition:transform .6s}
.gauge-cover{position:absolute;bottom:0;left:50%;transform:translateX(-50%);text-align:center;line-height:1.2}
.gauge-val{font-size:2rem;font-weight:800;color:#fff}
.gauge-max{font-size:.8rem;color:var(--dim)}
.gauge-label{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;margin-top:2px}
code{background:var(--bg);padding:2px 6px;border-radius:4px;font-size:.82rem;color:#7dd3fc;font-family:'SF Mono',Consolas,monospace}
pre{background:#0c1222;padding:14px 18px;border-radius:8px;overflow-x:auto;font-size:.78rem;line-height:1.5;color:#a5f3fc;font-family:'SF Mono',Consolas,monospace;border:1px solid var(--border)}
.tag{display:inline-block;background:var(--bg);border:1px solid var(--border);padding:2px 8px;border-radius:6px;font-size:.72rem;margin:2px}
.cover{text-align:center;padding:60px 20px 40px;border-bottom:2px solid var(--accent)}
.cover .logo{font-size:3rem;font-weight:800;background:linear-gradient(135deg,#3b82f6,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-.03em}
.cover .sub{color:var(--dim);font-size:1rem;margin-top:6px}
.kpi-row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:20px}
.kpi{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px 22px;text-align:center;min-width:130px}
.kpi .v{font-size:1.6rem;font-weight:700}
.kpi .k{font-size:.68rem;color:var(--dim);text-transform:uppercase;letter-spacing:.04em}
.chain-step{display:flex;align-items:center;gap:8px;margin:4px 0}
.chain-arrow{color:var(--accent);font-weight:700}
.finding-detail{margin:8px 0;padding:10px 14px;background:var(--bg);border-left:3px solid var(--accent);border-radius:0 8px 8px 0}
@media print{body{background:#fff;color:#1e293b}.card{border-color:#e2e8f0;break-inside:avoid}
  .cover .logo{color:#3b82f6;-webkit-text-fill-color:#3b82f6}h2{color:#1e293b}
  th{background:#f1f5f9}td{border-color:#e2e8f0}pre,code{background:#f8fafc;color:#0f172a}.badge{print-color-adjust:exact;-webkit-print-color-adjust:exact}}
</style></head><body><div class="container">"""


def _cover(data, now, meta):
    vc = meta.get("verdict_counts") or {}
    return f"""<div class="cover"><div class="logo">ALdeci</div>
<div class="sub">Penetration Test Report</div>
<p style="color:var(--dim);margin-top:8px;font-size:.85rem">Generated {now}</p>
<div class="kpi-row">
<div class="kpi"><div class="v" style="color:#dc2626">{vc.get('confirmed_vulnerable',0)}</div><div class="k">Confirmed Vulnerable</div></div>
<div class="kpi"><div class="v" style="color:#22c55e">{vc.get('verified_safe',0)}</div><div class="k">Verified Safe</div></div>
<div class="kpi"><div class="v" style="color:#94a3b8">{vc.get('not_applicable',0)}</div><div class="k">Not Applicable</div></div>
<div class="kpi"><div class="v" style="color:#eab308">{vc.get('unverified',0)}</div><div class="k">Unverified</div></div>
<div class="kpi"><div class="v">{meta.get('total_findings',0)}</div><div class="k">Total Findings</div></div>
<div class="kpi"><div class="v">{meta.get('total_cve_tests',0)}</div><div class="k">CVE Tests</div></div>
</div></div>"""


def _exec_summary(summary, risk, meta):
    headline = summary.get("headline", "N/A")
    gauge = risk_gauge(risk.get("score", 0), risk.get("level", "medium"))
    factors = "".join(
        f'<div style="margin:4px 0"><code>{f.get("factor","")}</code> +{f.get("contribution",0)}'
        f' <span style="color:var(--dim);font-size:.8rem">({f.get("detail","")})</span></div>'
        for f in risk.get("factors", [])
    )
    risks_li = "".join(f"<li style='margin:4px 0'>{r}</li>" for r in summary.get("top_risks", []))
    surf = summary.get("attack_surface", {})
    actions_rows = ""
    for a in summary.get("prioritized_actions", []):
        p = a.get("priority", "?")
        c = "#dc2626" if p == "P0" else "#ea580c" if p == "P1" else "#2563eb"
        actions_rows += (f'<tr><td><span class="badge" style="background:{c}">{p}</span></td>'
                         f'<td>{a.get("action","")}</td>'
                         f'<td style="color:var(--dim);font-size:.8rem">{a.get("detail","")[:120]}</td></tr>')
    actions_tbl = (f'<div class="card"><h3>Prioritized Actions</h3><table><thead><tr><th>Priority</th>'
                   f'<th>Action</th><th>Detail</th></tr></thead><tbody>{actions_rows}</tbody></table></div>'
                   if actions_rows else "")
    return f"""<h2>Executive Summary</h2>
<div class="card"><p style="font-size:1.1rem;font-weight:600;margin-bottom:16px">{headline}</p>
<div class="grid2"><div>{gauge}</div><div><h3>Risk Factors</h3>{factors}</div></div></div>
<div class="grid2"><div class="card"><h3>Top Risks</h3><ul style="padding-left:20px">{risks_li}</ul></div>
<div class="card"><h3>Attack Surface</h3><div class="grid2">
<div class="stat"><div class="num">{surf.get("total_findings",0)}</div><div class="lbl">Findings</div></div>
<div class="stat"><div class="num">{surf.get("critical_high",0)}</div><div class="lbl">Critical/High</div></div>
<div class="stat"><div class="num">{surf.get("exploitable_cves",0)}</div><div class="lbl">Exploitable CVEs</div></div>
<div class="stat"><div class="num">{surf.get("attack_chains",0)}</div><div class="lbl">Attack Chains</div></div>
</div></div></div>{actions_tbl}"""


def _verified_exploits_section(verified_exploits):
    """Verified exploits section ‚Äî the actionable heart of the report."""
    if not verified_exploits:
        return ""
    rows = ""
    for r in verified_exploits:
        ev = r.get("evidence", {})
        proof = ev.get("proof", "")
        title = r.get("title", r.get("cve_id", "?"))
        target = r.get("target_url", "?")
        sev = r.get("severity", "medium")
        cwe = r.get("cwe_id", "")
        # Build evidence detail HTML
        ev_items = ""
        for k, v in ev.items():
            if k in ("proof", "verification_method"):
                continue
            ev_items += f'<div style="font-size:.78rem;margin:2px 0"><code>{k}</code>: <strong>{v}</strong></div>'
        rows += (f'<div class="finding-detail" style="border-left-color:#dc2626">'
                 f'<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">'
                 f'{sev_badge(sev)} <strong>{title}</strong>'
                 f'{f" <code>{cwe}</code>" if cwe else ""}</div>'
                 f'<div style="font-size:.82rem;margin-bottom:4px"><strong>Target:</strong> <code>{target}</code></div>'
                 f'<div style="font-size:.82rem;margin-bottom:6px"><strong>Proof:</strong> {proof}</div>'
                 f'<div style="font-size:.82rem;color:var(--dim)">{r.get("description","")}</div>'
                 f'<details style="margin-top:6px"><summary style="cursor:pointer;font-size:.78rem;color:var(--accent)">Evidence Details</summary>'
                 f'<div style="margin-top:4px;padding:8px;background:var(--bg);border-radius:6px">{ev_items}</div></details>'
                 f'<div style="margin-top:6px;font-size:.78rem;color:var(--dim)"><strong>Remediation:</strong> {r.get("remediation","")}</div>'
                 f'</div>')
    count = len(verified_exploits)
    return (f'<h2 style="color:#dc2626">üî¥ Verified Exploits ({count})</h2>'
            f'<div class="card" style="border-color:#dc2626">'
            f'<p style="font-size:.85rem;margin-bottom:12px">These vulnerabilities were <strong>confirmed exploitable</strong> '
            f'with real HTTP requests and differential analysis. Each includes reproduction proof.</p>'
            f'{rows}</div>')


def _severity_table(sev_dist, findings):
    rows = ""
    for s in SEV_ORDER:
        cnt = sev_dist.get(s, 0)
        if cnt:
            pct = cnt / len(findings) * 100 if findings else 0
            rows += f"<tr><td>{sev_badge(s)}</td><td>{cnt}</td><td>{pct_bar(pct)}</td></tr>"
    return f"""<h2>Severity Distribution</h2><div class="card">
<table><thead><tr><th>Severity</th><th>Count</th><th>Distribution</th></tr></thead>
<tbody>{rows}</tbody></table></div>"""


def _target_breakdown(target_map):
    sections = ""
    for target, tfindings in sorted(target_map.items()):
        sc = {}
        for f in tfindings:
            s = f.get("severity", "unknown"); sc[s] = sc.get(s, 0) + 1
        badges = " ".join(f'{sev_badge(s)}&nbsp;√ó{c}' for s, c in sorted(sc.items(), key=lambda x: SEV_ORDER.index(x[0]) if x[0] in SEV_ORDER else 99))
        frows = ""
        for f in tfindings:
            frows += (f'<div class="finding-detail"><strong>{f.get("title", f.get("type", "?"))}</strong> '
                      f'{sev_badge(f.get("severity","unknown"))}'
                      f'<div style="color:var(--dim);font-size:.82rem;margin-top:4px">{f.get("description","")[:200]}</div></div>')
        sections += f'<div class="card"><h3><code>{target}</code> ‚Äî {len(tfindings)} findings</h3><div style="margin:8px 0">{badges}</div>{frows}</div>'
    return f"<h2>Findings by Target</h2>{sections}"


def _cve_matrix(cve_results):
    if not cve_results:
        return "<h2>CVE Assessment Matrix</h2><div class='card'><p>No CVE tests executed.</p></div>"
    _VC = {"VULNERABLE_VERIFIED": ("#dc2626", "üî¥ VULNERABLE"), "NOT_VULNERABLE_VERIFIED": ("#22c55e", "üü¢ NOT VULNERABLE"),
           "NOT_APPLICABLE": ("#94a3b8", "‚ö™ NOT APPLICABLE"), "UNVERIFIED": ("#eab308", "üü° UNVERIFIED")}
    # Count by verdict for the collapsible summary
    vc_counts = {}
    for r in cve_results:
        v = r.get("verdict", "UNVERIFIED")
        vc_counts[v] = vc_counts.get(v, 0) + 1
    na_count = vc_counts.get("NOT_APPLICABLE", 0)
    unv_count = vc_counts.get("UNVERIFIED", 0)
    rows = ""
    for r in cve_results:
        v = r.get("verdict", "UNVERIFIED"); vc, vl = _VC.get(v, ("#94a3b8", v))
        app_s, cov_s, con_s = r.get("applicability_score", 0), r.get("test_coverage_score", 0), r.get("confidence_score", 0)
        if v == "NOT_APPLICABLE":
            ev = r.get("evidence", {}); reason = ev.get("reason", "")
            detail = f'<div style="font-size:.78rem;color:var(--dim)">{reason if reason else "Product not detected on target"}</div>'
        elif v == "UNVERIFIED":
            ev = r.get("evidence", {})
            reason = ev.get("reason", "")
            method = r.get("test_method", "")
            detail = f'<div style="font-size:.78rem;color:var(--dim)">{reason or "No exploit test available"}'
            if method:
                detail += f' <span style="font-size:.72rem">(method: {method})</span>'
            detail += '</div>'
        else:
            detail = f'<div style="font-size:.78rem;color:var(--dim)">{r.get("description","")[:120]}</div>'
        rows += (f'<tr><td><code>{r.get("cve_id","?")}</code></td>'
                 f'<td style="font-size:.78rem;max-width:160px;overflow:hidden;text-overflow:ellipsis">{r.get("target_url","?")}</td>'
                 f'<td><span class="badge" style="background:{vc}">{vl}</span></td>'
                 f'<td>{sev_badge(r.get("severity","unknown"))} <span style="color:var(--dim);font-size:.78rem">CVSS {r.get("cvss_score",0)}</span></td>'
                 f'<td style="min-width:110px"><div style="font-size:.7rem;color:var(--dim)">Applicability</div>{pct_bar(app_s)}'
                 f'<div style="font-size:.7rem;color:var(--dim);margin-top:3px">Test Coverage</div>{pct_bar(cov_s)}'
                 f'<div style="font-size:.7rem;color:var(--dim);margin-top:3px">Evidence Qual</div>{pct_bar(con_s)}</td>'
                 f'<td>{detail}</td></tr>')
    # Collapsible if mostly NOT_APPLICABLE ‚Äî don't bury the user in irrelevant rows
    collapse = na_count + unv_count > 10
    summary_txt = f'{na_count} not applicable, {unv_count} unverified' if collapse else ''
    inner = (f'<table><thead><tr><th>CVE</th><th>Target</th><th>Verdict</th><th>Severity</th><th>Metrics</th><th>Details</th></tr></thead>'
             f'<tbody>{rows}</tbody></table>')
    if collapse:
        inner = (f'<details><summary style="cursor:pointer;font-size:.85rem;color:var(--accent);margin-bottom:8px">'
                 f'Show {len(cve_results)} CVE tests ({summary_txt})</summary>{inner}</details>')
    return f'<h2>CVE Assessment Matrix</h2><div class="card" style="overflow-x:auto">{inner}</div>'


def _mitre_section(mitre):
    if not mitre:
        return ""
    rows = "".join(
        f'<tr><td><code>{t.get("technique_id","")}</code></td><td>{t.get("technique_name","")}</td>'
        f'<td>{t.get("phase","")}</td><td>{sev_badge(t.get("severity","info"))}</td>'
        f'<td style="color:var(--dim);font-size:.82rem">{t.get("triggered_by","")}</td></tr>'
        for t in mitre)
    return (f'<h2>MITRE ATT&CK Mapping</h2><div class="card"><table><thead><tr><th>Technique ID</th><th>Name</th>'
            f'<th>Kill-Chain Phase</th><th>Severity</th><th>Triggered By</th></tr></thead><tbody>{rows}</tbody></table></div>')


def _chains_section(chains):
    if not chains:
        return ""
    items = ""
    for c in chains:
        steps_html = ""
        for i, s in enumerate(c.get("steps", [])):
            arrow = '<span class="chain-arrow">‚Üí</span> ' if i > 0 else ""
            steps_html += f'<div class="chain-step">{arrow}<span class="tag">{s.get("phase","")}</span> <span>{s.get("technique","")} ({s.get("name","")})</span></div>'
        bc = SEV_COLORS.get(c.get("risk_level", "medium"), "#d97706")
        items += (f'<div class="card"><h3>{c.get("entry_point","?")} ‚Äî {c.get("depth",0)} steps '
                  f'<span class="badge" style="background:{bc}">{c.get("risk_level","?").upper()}</span></h3>{steps_html}</div>')
    return f"<h2>Attack Chains</h2>{items}"


def _compliance_section(compliance):
    if not compliance:
        return ""
    cards = ""
    for fw, d in compliance.items():
        st = d.get("status", "unknown"); col = "#22c55e" if st == "compliant" else "#dc2626"
        pct = d.get("compliance_pct", 0)
        viols = "".join(f'<div style="margin:4px 0;font-size:.82rem">‚Ä¢ <code>{v.get("control","")}</code> {v.get("name","")}</div>' for v in d.get("violations", [])[:5])
        cards += (f'<div class="card"><h3>{fw} <span class="badge" style="background:{col}">{st.upper()}</span></h3>'
                  f'{pct_bar(pct)}<div style="margin-top:8px;font-size:.82rem;color:var(--dim)">Passing: {d.get("passing",0)}/{d.get("total_controls",0)} controls</div>{viols}</div>')
    return f'<h2>Compliance Validation</h2><div class="grid2">{cards}</div>'


def _fp_section(fp):
    if not fp:
        return ""
    acc = fp.get("estimated_accuracy", 0); tf = fp.get("total_flagged", 0); tv = fp.get("total_verified", 0)
    fp_rows = "".join(f'<tr><td><code>{f.get("cve_id","")}</code></td><td>{f.get("target","")}</td><td style="color:var(--dim)">{f.get("reason","")}</td></tr>' for f in fp.get("likely_false_positive_cves", []))
    tbl = f'<table style="margin-top:16px"><thead><tr><th>CVE</th><th>Target</th><th>Reason</th></tr></thead><tbody>{fp_rows}</tbody></table>' if fp_rows else ""
    return (f'<h2>False Positive Analysis</h2><div class="card"><div class="grid3">'
            f'<div class="stat"><div class="num">{acc}%</div><div class="lbl">Estimated Accuracy</div></div>'
            f'<div class="stat"><div class="num">{tf}</div><div class="lbl">Total Flagged</div></div>'
            f'<div class="stat"><div class="num">{tv}</div><div class="lbl">Verified Findings</div></div></div>{tbl}</div>')


def _poc_section(poc):
    if not poc:
        return ""
    items = ""
    for p in poc:
        cve_tag = f' <code>{p.get("cve_id","")}</code>' if p.get("cve_id") else ""
        poc_type = p.get("type", "")
        type_tag = f' <span class="tag">{poc_type}</span>' if poc_type else ""
        items += (f'<div class="finding-detail"><strong>{p.get("description","")}</strong>{cve_tag}{type_tag}'
                  f'<div style="color:var(--dim);font-size:.8rem;margin:4px 0">Target: {p.get("target","?")}</div>'
                  f'<pre>{p.get("curl_command","")}</pre></div>')
    return (f'<h2>üîß Proof-of-Concept Commands ({len(poc)})</h2>'
            f'<div class="card"><p style="font-size:.85rem;margin-bottom:12px;color:var(--dim)">'
            f'Copy-paste these commands to reproduce each finding.</p>{items}</div>')


def _ai_transparency_section(ai: dict, meta: dict) -> str:
    """Full AI transparency disclosure section."""
    ai_enabled = ai.get("ai_enabled", False)
    if not ai_enabled and not ai.get("providers_available"):
        # No AI info at all ‚Äî show a short notice
        return (
            '<h2>AI Engine Disclosure</h2><div class="card">'
            '<p style="color:var(--dim)">AI analysis layer was <strong>not active</strong> for this scan. '
            'The deterministic 4-stage verification pipeline produced all results. '
            'To enable AI-powered multi-LLM consensus, configure API keys for OpenAI, Anthropic, and/or Google Gemini.</p></div>'
        )

    providers = ai.get("providers_available", {})
    role_map = {"openai": "GPT-4 (Team Lead)", "anthropic": "Claude (Developer)", "gemini": "Gemini (Architect)"}
    prov_rows = "".join(
        f'<tr><td><strong>{n.title()}</strong></td>'
        f'<td>{"‚úÖ Configured" if v else "‚ùå Not configured"}</td>'
        f'<td>{role_map.get(n, "‚Äî")}</td></tr>'
        for n, v in providers.items()
    )

    consensus_cfg = ai.get("consensus_config", {})
    weights = consensus_cfg.get("weights", {})
    threshold = consensus_cfg.get("threshold", "‚Äî")

    # AI risk assessments table
    assessments = ai.get("ai_risk_assessments", [])
    assess_rows = ""
    for a in assessments[:10]:
        assess_rows += (
            f'<tr><td><code>{a.get("cve_id","")}</code></td>'
            f'<td>{a.get("target","")}</td>'
            f'<td>{a.get("consensus_action","‚Äî")}</td>'
            f'<td>{a.get("consensus_confidence",0):.1%}</td>'
            f'<td style="font-size:.78rem">{a.get("consensus_reasoning","")[:120]}</td></tr>'
        )

    # Exploit strategies
    exploits = ai.get("ai_enhanced_findings", [])
    exploit_rows = ""
    for e in exploits[:5]:
        exploit_rows += (
            f'<tr><td><code>{e.get("cve_id","")}</code></td>'
            f'<td>{e.get("exploit_type","")}</td>'
            f'<td>{e.get("complexity","")}</td>'
            f'<td>{e.get("success_probability",0):.0%}</td>'
            f'<td>{", ".join(e.get("evasion_techniques",[])[:3]) or "‚Äî"}</td></tr>'
        )

    status_color = "#22c55e" if ai_enabled else "#eab308"
    status_label = "ACTIVE" if ai_enabled else "DEGRADED"

    html = f'''<h2>AI Engine Disclosure</h2><div class="card">
<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
<span class="badge" style="background:{status_color};font-size:.85rem;padding:6px 14px">{status_label}</span>
<span style="color:var(--dim);font-size:.85rem">PentAGI Multi-AI Consensus Engine</span>
</div>

<div class="grid2">
<div>
<h3>Architecture</h3>
<p style="font-size:.85rem">ALdeci is built on <strong>PentAGI</strong>, a multi-AI orchestration framework that coordinates
3 LLM providers in parallel for consensus-based security decisions. Each provider plays a specialized role:</p>
<table style="margin-top:8px">
<tr style="background:var(--bg)"><th>Provider</th><th>Status</th><th>Role</th></tr>
{prov_rows}
</table>
</div>
<div>
<h3>Consensus Configuration</h3>
<table>
<tr><td><strong>Threshold</strong></td><td>{threshold}</td></tr>
<tr><td><strong>Architect weight</strong></td><td>{weights.get("architect","‚Äî")}</td></tr>
<tr><td><strong>Developer weight</strong></td><td>{weights.get("developer","‚Äî")}</td></tr>
<tr><td><strong>Lead weight</strong></td><td>{weights.get("lead","‚Äî")}</td></tr>
<tr><td><strong>Timeout</strong></td><td>{consensus_cfg.get("timeout_seconds","‚Äî")}s per call</td></tr>
<tr><td><strong>Max retries</strong></td><td>{consensus_cfg.get("max_retries","‚Äî")}</td></tr>
</table>
<h3 style="margin-top:12px">Statistics</h3>
<table>
<tr><td>Consensus decisions</td><td><strong>{ai.get("consensus_decisions",0)}</strong></td></tr>
<tr><td>Exploit strategies</td><td><strong>{ai.get("exploit_strategies_generated",0)}</strong></td></tr>
<tr><td>Total LLM calls</td><td>{ai.get("total_llm_calls",0)}</td></tr>
<tr><td>Successful calls</td><td>{ai.get("successful_llm_calls",0)}</td></tr>
<tr><td>Fallback calls</td><td>{ai.get("fallback_llm_calls",0)}</td></tr>
<tr><td>AI duration</td><td>{ai.get("duration_seconds",0):.1f}s</td></tr>
</table>
</div>
</div>'''

    if assess_rows:
        html += f'''
<h3 style="margin-top:20px">AI Risk Assessments (Multi-LLM Consensus)</h3>
<div style="overflow-x:auto"><table>
<tr style="background:var(--bg)"><th>CVE</th><th>Target</th><th>Action</th><th>Confidence</th><th>Reasoning</th></tr>
{assess_rows}</table></div>'''

    if exploit_rows:
        html += f'''
<h3 style="margin-top:20px">AI-Generated Exploit Strategies</h3>
<div style="overflow-x:auto"><table>
<tr style="background:var(--bg)"><th>CVE</th><th>Type</th><th>Complexity</th><th>Success Prob.</th><th>Evasion Techniques</th></tr>
{exploit_rows}</table></div>'''

    html += '</div>'
    return html


def _methodology(meta: dict):
    ai_powered = meta.get("ai_powered", False)
    ai_section = ""
    if ai_powered:
        ai_section = '''<h3 style="margin-top:20px">AI Orchestration Layer (PentAGI)</h3>
<p>On top of the deterministic pipeline, ALdeci layers a <strong>Multi-AI Consensus Engine</strong>:</p>
<ol style="padding-left:20px;margin-top:8px">
<li><strong>Gemini (Architect)</strong> ‚Äî Attack surface analysis, business impact assessment, architecture-level risk</li>
<li><strong>Claude (Developer)</strong> ‚Äî Exploitability analysis, tool selection, payload design, code-level risk</li>
<li><strong>GPT-4 (Team Lead)</strong> ‚Äî Strategy synthesis, risk prioritization, success criteria, go/no-go decisions</li>
<li><strong>Consensus Composer</strong> ‚Äî Weighted merge (architect=0.35, developer=0.40, lead=0.25) with configurable threshold</li>
</ol>
<p style="margin-top:8px;font-size:.85rem;color:var(--dim)">Additionally, the <strong>Intelligent Exploit Generator</strong> uses
LLMs to create targeted payloads with evasion techniques, and the <strong>AI Findings Prioritizer</strong> re-ranks general
findings by real-world exploitability.</p>'''

    return f'''<h2>Methodology</h2><div class="card"><div class="grid2"><div>
<h3>Testing Approach</h3><p>ALdeci uses a 4-stage verification pipeline to minimize false positives:</p>
<ol style="padding-left:20px;margin-top:8px">
<li><strong>Product Detection</strong> ‚Äî Fingerprint target tech stack via headers, response patterns, cookies</li>
<li><strong>Version Fingerprinting</strong> ‚Äî Identify specific product versions for vulnerability applicability</li>
<li><strong>Exploit Verification</strong> ‚Äî Send targeted exploit payloads and analyze responses</li>
<li><strong>Differential Confirmation</strong> ‚Äî Compare benign vs. malicious input to eliminate false positives</li>
</ol></div><div><h3>Verdict System</h3><table>
<tr><td><span class="badge" style="background:#dc2626">VULNERABLE VERIFIED</span></td><td>Confirmed exploitable</td></tr>
<tr><td><span class="badge" style="background:#22c55e">NOT VULNERABLE VERIFIED</span></td><td>Real test ran, target clean</td></tr>
<tr><td><span class="badge" style="background:#94a3b8">NOT APPLICABLE</span></td><td>CVE doesn't match tech stack</td></tr>
<tr><td><span class="badge" style="background:#eab308">UNVERIFIED</span></td><td>No test / insufficient evidence</td></tr></table>
<h3 style="margin-top:16px">Scoring</h3><table>
<tr><td><strong>Applicability</strong></td><td>Does CVE match detected technology?</td></tr>
<tr><td><strong>Test Coverage</strong></td><td>Real exploit test or just a probe?</td></tr>
<tr><td><strong>Evidence Quality</strong></td><td>Strength of evidence for verdict</td></tr></table></div></div>
{ai_section}
<div style="margin-top:16px;padding:12px;background:var(--bg);border-radius:8px;font-size:.82rem;color:var(--dim)">
<strong>Min confidence threshold:</strong> 0.60 (60%). <strong>Scan phases:</strong> 19 (headers, SSL/TLS, SQLi, XSS, info disclosure, path traversal, CORS, cookies, HTTP methods, tech fingerprint, WAF, open redirect, CRLF, API discovery, SSTI, request smuggling, host header injection, deserialization, cache poisoning).</div></div>'''


def _footer(now, meta: dict):
    engine = meta.get("engine", "aldeci_deterministic_v3")
    ai_powered = meta.get("ai_powered", False)
    engine_desc = f"{engine} ‚Ä¢ {'Multi-AI Consensus + ' if ai_powered else ''}4-stage verification"
    return (f'<div style="text-align:center;padding:40px 0 20px;color:var(--dim);font-size:.75rem;border-top:1px solid var(--border);margin-top:40px">'
            f'<p><strong>ALdeci</strong> ‚Äî Security Vulnerability Management Platform</p>'
            f'<p>Report generated {now} ‚Ä¢ Engine: {engine_desc}</p>'
            f'<p style="margin-top:8px">This report is confidential and intended for authorized recipients only.</p>'
            f'</div></div></body></html>')


if __name__ == "__main__":
    use_cache = "--cached" in sys.argv
    if use_cache:
        data = load_cached()
        if not data:
            print("[!] No cached data found. Running live scan...")
            data = run_pentest()
    else:
        data = run_pentest()

    html = build_html(data)
    REPORT_FILE.write_text(html)
    print(f"[+] Report saved to {REPORT_FILE}")
    abs_path = REPORT_FILE.resolve()
    print(f"[*] Opening in browser: file://{abs_path}")
    webbrowser.open(f"file://{abs_path}")

