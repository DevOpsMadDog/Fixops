"""Database adapter for enterprise micro pen testing persistence.

This module provides database persistence for micro pen testing data.
Currently uses in-memory storage but can be extended to use SQLite, PostgreSQL, etc.
"""

from __future__ import annotations

from typing import Optional

from src.services.micro_pentest import (
    MicroPenTestRequest,
    MicroPenTestResult,
    MicroPenTestStatus,
)


class MicroPenTestDB:
    """Database adapter for micro pen testing data."""

    def __init__(self, db_path: Optional[str] = None):
        """Initialize database adapter.

        Args:
            db_path: Path to database file. If None, uses in-memory storage.
        """
        self.db_path = db_path
        # For now, using in-memory storage
        # Can be extended to use SQLite, PostgreSQL, etc.
        self._requests: dict[str, MicroPenTestRequest] = {}
        self._results: dict[str, list[MicroPenTestResult]] = {}

    def save_request(self, request: MicroPenTestRequest) -> MicroPenTestRequest:
        """Save a micro pen test request."""
        self._requests[request.id] = request
        return request

    def get_request(self, request_id: str) -> Optional[MicroPenTestRequest]:
        """Get a micro pen test request by ID."""
        return self._requests.get(request_id)

    def list_requests(
        self,
        service_name: Optional[str] = None,
        status: Optional[MicroPenTestStatus] = None,
        limit: int = 100,
        offset: int = 0,
    ) -> list[MicroPenTestRequest]:
        """List micro pen test requests."""
        requests = list(self._requests.values())

        if service_name:
            requests = [r for r in requests if r.service_name == service_name]
        if status:
            requests = [r for r in requests if r.status == status]

        requests.sort(key=lambda x: x.created_at, reverse=True)
        return requests[offset : offset + limit]

    def save_result(self, result: MicroPenTestResult) -> MicroPenTestResult:
        """Save a micro pen test result."""
        if result.request_id not in self._results:
            self._results[result.request_id] = []
        self._results[result.request_id].append(result)
        return result

    def get_results(self, request_id: str) -> list[MicroPenTestResult]:
        """Get results for a micro pen test request."""
        return self._results.get(request_id, [])

    def list_results(
        self,
        service_name: Optional[str] = None,
        severity: Optional[str] = None,
        limit: int = 100,
        offset: int = 0,
    ) -> list[MicroPenTestResult]:
        """List all micro pen test results."""
        all_results = []
        for results in self._results.values():
            all_results.extend(results)

        if service_name:
            all_results = [r for r in all_results if r.service_name == service_name]
        if severity:
            all_results = [r for r in all_results if r.severity.value == severity]

        all_results.sort(key=lambda x: x.created_at, reverse=True)
        return all_results[offset : offset + limit]


__all__ = ["MicroPenTestDB"]
