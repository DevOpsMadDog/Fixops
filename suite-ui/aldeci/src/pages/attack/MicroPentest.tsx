import { useState, useEffect, useRef } from 'react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import api, { getApiBaseUrl } from '../../lib/api';

/* eslint-disable @typescript-eslint/no-explicit-any */

const SEV_COLORS: Record<string, string> = {
  critical: 'bg-red-500/20 text-red-400',
  high: 'bg-orange-500/20 text-orange-400',
  medium: 'bg-yellow-500/20 text-yellow-400',
  low: 'bg-blue-500/20 text-blue-400',
  info: 'bg-gray-500/20 text-gray-400',
};

const VERDICT_COLORS: Record<string, string> = {
  VULNERABLE_VERIFIED: 'bg-red-500/20 text-red-400 border border-red-500/30',
  NOT_VULNERABLE_VERIFIED: 'bg-green-500/20 text-green-400 border border-green-500/30',
  NOT_APPLICABLE: 'bg-gray-500/20 text-gray-400 border border-gray-500/30',
  UNVERIFIED: 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30',
};

const SCAN_PHASES = [
  'Architecture Profiling', 'Security Headers', 'SSL/TLS', 'SQL Injection',
  'XSS Detection', 'Information Disclosure', 'Path Traversal', 'CORS Config',
  'Cookie Security', 'HTTP Methods', 'Tech Fingerprinting', 'WAF Detection',
  'Open Redirect', 'CRLF Injection', 'API Discovery', 'SSTI Detection',
  'Request Smuggling', 'Host Header Injection', 'Deserialization', 'Cache Poisoning',
  'AI Analysis',
];

const MicroPentest = () => {
  const [targets, setTargets] = useState('');
  const [cveIds, setCveIds] = useState('');
  const [running, setRunning] = useState(false);
  const [scanResult, setScanResult] = useState<any>(null);
  const [error, setError] = useState('');
  const [elapsed, setElapsed] = useState(0);
  const [reportReady, setReportReady] = useState(false);
  const [scanPhase, setScanPhase] = useState('');
  const abortRef = useRef<AbortController | null>(null);

  const BASE = getApiBaseUrl();

  // Check if a report already exists on mount
  useEffect(() => {
    api.attack.microPentest.getReportData()
      .then(() => setReportReady(true))
      .catch(() => setReportReady(false));
  }, []);

  // Timer + phase animation while running
  useEffect(() => {
    if (!running) return;
    const t0 = Date.now();
    const iv = setInterval(() => {
      const secs = Math.round((Date.now() - t0) / 1000);
      setElapsed(secs);
      // Rotate through phase names to give visual feedback
      const idx = Math.min(Math.floor(secs / 1.5), SCAN_PHASES.length - 1);
      setScanPhase(SCAN_PHASES[idx]);
    }, 500);
    return () => clearInterval(iv);
  }, [running]);

  const handleRun = async () => {
    const targetList = targets.split(',').map(t => t.trim()).filter(Boolean);
    const cveList = cveIds.split(',').map(c => c.trim()).filter(Boolean);
    if (!targetList.length) { setError('Enter at least one target URL'); return; }
    setRunning(true);
    setError('');
    setScanResult(null);
    setElapsed(0);
    setScanPhase(SCAN_PHASES[0]);
    const ctrl = new AbortController();
    abortRef.current = ctrl;
    try {
      const result = await api.attack.microPentest.run({
        cve_ids: cveList,
        target_urls: targetList,
        context: { safe_mode: true, scan_type: 'advanced' },
      });
      setScanResult(result);
      setReportReady(false);
    } catch (err: any) {
      if (err?.code === 'ECONNABORTED' || err?.message?.includes('timeout')) {
        setError(`Scan timed out after ${elapsed}s. The scan is still running on the server ‚Äî try again in a moment.`);
      } else {
        setError(err?.response?.data?.detail || err.message || 'Scan failed ‚Äî check browser console for details');
      }
      console.error('[MicroPentest] Scan error:', err);
    } finally {
      setRunning(false);
      abortRef.current = null;
    }
  };

  const handleGenerateReport = async () => {
    const targetList = targets.split(',').map(t => t.trim()).filter(Boolean);
    const cveList = cveIds.split(',').map(c => c.trim()).filter(Boolean);
    if (!targetList.length) { setError('Enter at least one target URL'); return; }
    setRunning(true);
    setError('');
    setScanPhase(SCAN_PHASES[0]);
    try {
      const res = await api.attack.microPentest.generateReport({
        cve_ids: cveList,
        target_urls: targetList,
        context: { safe_mode: true, scan_type: 'advanced' },
      });
      setReportReady(true);
      // If the generate endpoint also returned scan data, use it
      if (res?.scan_summary) setScanResult(res);
    } catch (err: any) {
      if (err?.code === 'ECONNABORTED' || err?.message?.includes('timeout')) {
        setError(`Report generation timed out after ${elapsed}s. Try again shortly.`);
      } else {
        setError(err?.response?.data?.detail || err.message || 'Report generation failed');
      }
      console.error('[MicroPentest] Report error:', err);
    } finally {
      setRunning(false);
    }
  };

  const handleDownload = () => {
    window.open(`${BASE}/api/v1/micro-pentest/report/download`, '_blank');
  };

  const handleViewReport = () => {
    window.open(`${BASE}/api/v1/micro-pentest/report/view`, '_blank');
  };

  // Computed values from scan result
  const meta = scanResult?.scan_metadata || {};
  const ai = meta?.ai_analysis || {};
  const findings = scanResult?.findings || [];
  const cveResults = scanResult?.cve_results || [];
  const risk = meta?.risk_score || {};
  const compliance = meta?.compliance || {};

  const vulnVerified = cveResults.filter((c: any) => c.verdict === 'VULNERABLE_VERIFIED').length;
  const notApplicable = cveResults.filter((c: any) => c.verdict === 'NOT_APPLICABLE').length;
  const unverified = cveResults.filter((c: any) => c.verdict === 'UNVERIFIED').length;

  const critFindings = findings.filter((f: any) => f.severity === 'critical').length;
  const highFindings = findings.filter((f: any) => f.severity === 'high').length;

  return (
    <div className="p-6 space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold">üî¨ Micro Pentest</h1>
          <p className="text-muted-foreground mt-1">
            AI-Powered Architecture-Aware Penetration Testing ‚Äî PentAGI Multi-AI Consensus Engine
          </p>
        </div>
        {/* AI Engine Status */}
        <div className="flex items-center gap-3">
          <span className={`px-3 py-1.5 rounded-full text-xs font-bold ${
            ai.ai_enabled
              ? 'bg-green-500/20 text-green-400 border border-green-500/30'
              : scanResult
                ? 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30'
                : 'bg-gray-500/20 text-gray-400 border border-gray-500/30'
          }`}>
            {ai.ai_enabled ? '‚óè ACTIVE' : scanResult ? '‚óè DEGRADED' : '‚óã IDLE'}
          </span>
          <span className="text-xs text-muted-foreground">PentAGI Engine</span>
        </div>
      </div>

      {/* ‚îÄ‚îÄ Scan Configuration ‚îÄ‚îÄ */}
      <Card>
        <CardHeader><CardTitle>üéØ Scan Configuration</CardTitle></CardHeader>
        <CardContent className="space-y-4">
          <div className="space-y-2">
            <label className="text-sm font-medium">Target URLs (comma-separated)</label>
            <Input value={targets} onChange={e => setTargets(e.target.value)}
              placeholder="https://example.com, https://httpbin.org" />
          </div>
          <div className="space-y-2">
            <label className="text-sm font-medium">CVE IDs (comma-separated, optional)</label>
            <Input value={cveIds} onChange={e => setCveIds(e.target.value)}
              placeholder="CVE-2021-44228, CVE-2023-44487" />
          </div>
          <div className="flex flex-wrap items-center gap-3">
            <Button onClick={handleRun} disabled={running || !targets.trim()} size="lg">
              {running ? `‚è≥ Scanning... (${elapsed}s)` : '‚ñ∂ Run Micro Pentest'}
            </Button>
            <Button onClick={handleGenerateReport} disabled={running || !targets.trim()} variant="outline" size="lg">
              {running ? '‚è≥ Generating...' : 'üìÑ Run + Generate Report'}
            </Button>
            {reportReady && (
              <>
                <Button onClick={handleViewReport} variant="outline" size="lg">üëÅ View Report</Button>
                <Button onClick={handleDownload} variant="outline" size="lg">‚¨á Download Report</Button>
              </>
            )}
          </div>
          {/* Live scan progress */}
          {running && (
            <div className="mt-3 p-3 rounded-lg bg-blue-500/10 border border-blue-500/20 space-y-2">
              <div className="flex items-center justify-between text-sm">
                <span className="text-blue-400 font-medium animate-pulse">üîç {scanPhase}...</span>
                <span className="text-muted-foreground font-mono">{elapsed}s elapsed</span>
              </div>
              <div className="w-full bg-gray-700 rounded-full h-1.5">
                <div className="h-1.5 rounded-full bg-blue-500 transition-all duration-500"
                  style={{ width: `${Math.min(95, (elapsed / 40) * 100)}%` }} />
              </div>
              <p className="text-xs text-muted-foreground">
                Scanning {targets.split(',').filter(t => t.trim()).length} target(s) across 19 vulnerability categories + AI analysis...
              </p>
            </div>
          )}
          {error && (
            <div className="mt-2 p-3 rounded-lg bg-red-500/10 border border-red-500/20">
              <p className="text-red-400 text-sm">‚ùå {error}</p>
            </div>
          )}
        </CardContent>
      </Card>

      {/* ‚îÄ‚îÄ Results Dashboard ‚îÄ‚îÄ */}
      {scanResult && (
        <>
          {/* KPI Row */}
          <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
            <Card><CardContent className="pt-4 text-center">
              <div className="text-3xl font-bold text-red-400">{vulnVerified}</div>
              <div className="text-xs text-muted-foreground mt-1">Verified Exploits</div>
            </CardContent></Card>
            <Card><CardContent className="pt-4 text-center">
              <div className="text-3xl font-bold text-gray-400">{notApplicable}</div>
              <div className="text-xs text-muted-foreground mt-1">Not Applicable</div>
            </CardContent></Card>
            <Card><CardContent className="pt-4 text-center">
              <div className="text-3xl font-bold text-yellow-400">{unverified}</div>
              <div className="text-xs text-muted-foreground mt-1">Unverified</div>
            </CardContent></Card>
            <Card><CardContent className="pt-4 text-center">
              <div className="text-3xl font-bold" style={{ color: risk.level === 'CRITICAL' ? '#ef4444' : risk.level === 'HIGH' ? '#f97316' : '#eab308' }}>
                {risk.score ?? '‚Äî'}/10
              </div>
              <div className="text-xs text-muted-foreground mt-1">Risk: {risk.level || '‚Äî'}</div>
            </CardContent></Card>
            <Card><CardContent className="pt-4 text-center">
              <div className="text-3xl font-bold">{critFindings + highFindings}</div>
              <div className="text-xs text-muted-foreground mt-1">Critical+High Findings</div>
            </CardContent></Card>
          </div>

          {/* AI Engine + Compliance Row */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {/* AI Engine Status */}
            <Card>
              <CardHeader><CardTitle>ü§ñ AI Engine Status</CardTitle></CardHeader>
              <CardContent className="space-y-3">
                <div className="flex items-center gap-2">
                  <span className={`px-2 py-1 rounded text-xs font-bold ${ai.ai_enabled ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'}`}>
                    {ai.ai_enabled ? 'ACTIVE' : 'DEGRADED'}
                  </span>
                  <span className="text-sm text-muted-foreground">{meta.engine || 'unknown'}</span>
                </div>
                <div className="grid grid-cols-3 gap-2 text-sm">
                  {Object.entries(ai.providers_available || {}).map(([name, avail]) => (
                    <div key={name} className="flex items-center gap-1.5">
                      <span className={`w-2 h-2 rounded-full ${avail ? 'bg-green-400' : 'bg-red-400'}`} />
                      <span className="capitalize">{name}</span>
                    </div>
                  ))}
                </div>
                <div className="grid grid-cols-2 gap-x-4 gap-y-1 text-xs text-muted-foreground">
                  <span>Consensus Decisions:</span><span className="font-mono">{ai.consensus_decisions ?? 0}</span>
                  <span>Total LLM Calls:</span><span className="font-mono">{ai.total_llm_calls ?? 0}</span>
                  <span>Successful:</span><span className="font-mono">{ai.successful_llm_calls ?? 0}</span>
                  <span>Fallback:</span><span className="font-mono">{ai.fallback_llm_calls ?? 0}</span>
                  <span>Exploit Strategies:</span><span className="font-mono">{ai.exploit_strategies_generated ?? 0}</span>
                  <span>Duration:</span><span className="font-mono">{ai.duration_seconds ?? 0}s</span>
                </div>
              </CardContent>
            </Card>

            {/* Compliance */}
            <Card>
              <CardHeader><CardTitle>üìã Compliance</CardTitle></CardHeader>
              <CardContent>
                {Object.keys(compliance).length === 0 ? (
                  <p className="text-muted-foreground text-sm">No compliance data</p>
                ) : (
                  <div className="space-y-2">
                    {Object.entries(compliance).map(([fw, data]: [string, any]) => (
                      <div key={fw} className="flex items-center justify-between">
                        <span className="text-sm font-medium uppercase">{fw}</span>
                        <div className="flex items-center gap-2">
                          <div className="w-24 bg-gray-700 rounded-full h-2">
                            <div className="h-2 rounded-full" style={{
                              width: `${data.pass_rate ?? 0}%`,
                              backgroundColor: (data.pass_rate ?? 0) >= 80 ? '#22c55e' : (data.pass_rate ?? 0) >= 50 ? '#eab308' : '#ef4444',
                            }} />
                          </div>
                          <span className={`text-xs font-bold ${data.compliant ? 'text-green-400' : 'text-red-400'}`}>
                            {Math.round(data.pass_rate ?? 0)}%
                          </span>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </CardContent>
            </Card>
          </div>

          {/* Findings Table */}
          <Card>
            <CardHeader>
              <CardTitle>üîç Findings ({findings.length})</CardTitle>
            </CardHeader>
            <CardContent>
              {findings.length === 0 ? (
                <p className="text-muted-foreground text-sm text-center py-4">No findings</p>
              ) : (
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead>
                      <tr className="border-b border-gray-700">
                        <th className="text-left py-2 px-2">Severity</th>
                        <th className="text-left py-2 px-2">Type</th>
                        <th className="text-left py-2 px-2">Title</th>
                        <th className="text-left py-2 px-2">Target</th>
                        <th className="text-left py-2 px-2">Confidence</th>
                      </tr>
                    </thead>
                    <tbody>
                      {findings.slice(0, 50).map((f: any, i: number) => (
                        <tr key={i} className="border-b border-gray-800 hover:bg-gray-800/50">
                          <td className="py-2 px-2">
                            <span className={`px-2 py-0.5 rounded text-xs ${SEV_COLORS[f.severity] || SEV_COLORS.info}`}>
                              {(f.severity || 'info').toUpperCase()}
                            </span>
                          </td>
                          <td className="py-2 px-2 font-mono text-xs">{f.type || '‚Äî'}</td>
                          <td className="py-2 px-2">{f.title || f.description || '‚Äî'}</td>
                          <td className="py-2 px-2 text-xs text-muted-foreground truncate max-w-[200px]">{f.target || '‚Äî'}</td>
                          <td className="py-2 px-2 font-mono text-xs">{f.confidence ? `${f.confidence}%` : '‚Äî'}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                  {findings.length > 50 && (
                    <p className="text-xs text-muted-foreground text-center mt-2">
                      Showing 50 of {findings.length} findings. Download the full report for all details.
                    </p>
                  )}
                </div>
              )}
            </CardContent>
          </Card>

          {/* CVE Results */}
          {cveResults.length > 0 && (
            <Card>
              <CardHeader><CardTitle>üß¨ CVE Verification Results ({cveResults.length})</CardTitle></CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                  {cveResults.map((cve: any, i: number) => (
                    <div key={i} className="p-3 rounded-lg border border-gray-700 space-y-1.5">
                      <div className="flex items-center justify-between">
                        <span className="font-mono text-sm font-bold">{cve.cve_id}</span>
                        <span className={`px-2 py-0.5 rounded text-xs ${VERDICT_COLORS[cve.verdict] || ''}`}>
                          {cve.verdict?.replace(/_/g, ' ') || 'UNKNOWN'}
                        </span>
                      </div>
                      <div className="grid grid-cols-3 gap-1 text-xs text-muted-foreground">
                        <span>Applicability: <span className="font-mono text-foreground">{cve.applicability_score ?? '‚Äî'}%</span></span>
                        <span>Coverage: <span className="font-mono text-foreground">{cve.test_coverage_score ?? '‚Äî'}%</span></span>
                        <span>Confidence: <span className="font-mono text-foreground">{cve.confidence_score ?? '‚Äî'}%</span></span>
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          )}
        </>
      )}
    </div>
  );
};

export default MicroPentest;
