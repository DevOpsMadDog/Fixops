# FixOps Provenance

This guide explains how FixOps emits [RSA-signed evidence bundles (RSA-SHA256 signature (SLSA attestations roadmap)s roadmap)](https://slsa.dev/spec/v1.0/provenance)
metadata for release artefacts, how to generate and verify attestations locally, and how to
retrieve attestations via the API or CI pipeline outputs.

## Schema Overview

Attestations generated by FixOps follow the SLSA v1 provenance schema and include:

| Field | Description |
| ----- | ----------- |
| `slsaVersion` | Always `"1.0"` to indicate SLSA v1 provenance. |
| `builder.id` | URI identifying the build service (defaults to `urn:fixops:builder:local`). |
| `buildType` | URI describing the build recipe (defaults to GitHub Actions runs). |
| `source.uri` | Source repository URI that produced the artefact. |
| `metadata` | Build metadata including start/finish timestamps and reproducibility flag. |
| `subject[]` | Array of artefacts covered by the attestation; FixOps records SHA-256 digests. |
| `materials[]` | Optional array of build inputs with URIs and optional digests. |

All attestations are canonical JSON with stable key ordering to simplify integrity checks.

## CLI Usage

Use the `cli/fixops-provenance` tool to generate and validate attestations:

```bash
# Generate an attestation for a local artefact
cli/fixops-provenance attest \
  --artifact artefacts/build.tar.gz \
  --out artefacts/attestations/build.tar.gz.json \
  --builder-id "urn:fixops:builder:ci" \
  --source-uri "https://github.com/DevOpsMadDog/Fixops@${GIT_SHA}"

# Verify an attestation
cli/fixops-provenance verify \
  --artifact artefacts/build.tar.gz \
  --attestation artefacts/attestations/build.tar.gz.json \
  --builder-id "urn:fixops:builder:ci" \
  --source-uri "https://github.com/DevOpsMadDog/Fixops@${GIT_SHA}"
```

Additional materials or metadata can be supplied with `--material '{"uri": "dependency.tgz"}'`
or `--metadata '{"buildInvocationId": "123"}'` (repeat `--material` for multiple entries).

The CLI returns exit code `0` on success and `1` if verification fails.

## API Endpoints

Authenticated callers can download stored attestations from the FastAPI service:

- `GET /provenance/` &rarr; Lists available attestation JSON filenames.
- `GET /provenance/{name}` &rarr; Returns the parsed attestation for `name`. The endpoint
  accepts either the artefact stem or full filename (e.g., `build.tar.gz` or
  `build.tar.gz.json`).

The API reads attestations from the configured `provenance_dir` (default
`artifacts/attestations/<mode>` within the allowlisted data root).

## CI Workflow

When a release tag is pushed, `.github/workflows/provenance.yml`:

1. Archives the repository contents to `artifacts/fixops-${{ github.sha }}.tar.gz`.
2. Generates an attestation via `cli/fixops-provenance attest`.
3. Uploads the resulting JSON to the workflow artefacts bucket under `attestations/`.

The uploaded attestation can be downloaded from the workflow run and verified with the CLI
commands shown above.

## Local Verification Flow

1. Build or download the artefact you wish to validate.
2. Generate (or fetch) the provenance JSON.
3. Run `cli/fixops-provenance verify` against the artefact and attestation.
4. Optionally query the API at `/provenance/<artefact>` to cross-check the stored version.

Successful verification confirms that the attested SHA-256 digest matches the local artefact
and that the recorded builder, source URI, and build type align with expectations.
