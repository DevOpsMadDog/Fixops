"""Tests for micro penetration test API router."""
from unittest.mock import AsyncMock, patch

import pytest
from fastapi import FastAPI
from fastapi.testclient import TestClient

from apps.api.micro_pentest_router import router
from core.micro_pentest import MicroPentestResult, MicroPentestStatus


@pytest.fixture
def app():
    """Create test FastAPI app with router."""
    app = FastAPI()
    app.include_router(router)
    return app


@pytest.fixture
def client(app):
    """Create test client."""
    return TestClient(app)


class TestRunPentestEndpoint:
    """Tests for POST /api/v1/micro-pentest/run endpoint."""

    def test_empty_cve_ids(self, client):
        """Test validation error when cve_ids is empty."""
        response = client.post(
            "/api/v1/micro-pentest/run",
            json={"cve_ids": [], "target_urls": ["http://example.com"]},
        )
        assert response.status_code == 400
        assert "At least one CVE ID is required" in response.json()["detail"]

    def test_empty_target_urls(self, client):
        """Test validation error when target_urls is empty."""
        response = client.post(
            "/api/v1/micro-pentest/run",
            json={"cve_ids": ["CVE-2024-1234"], "target_urls": []},
        )
        assert response.status_code == 400
        assert "At least one target URL is required" in response.json()["detail"]

    def test_successful_run(self, client):
        """Test successful micro pentest run."""
        mock_result = MicroPentestResult(
            status="started",
            flow_id=12345,
            cve_ids=["CVE-2024-1234"],
            target_urls=["http://example.com"],
            message="Micro penetration test started for 1 CVEs",
        )

        with patch(
            "apps.api.micro_pentest_router.run_micro_pentest",
            new_callable=AsyncMock,
            return_value=mock_result,
        ):
            response = client.post(
                "/api/v1/micro-pentest/run",
                json={
                    "cve_ids": ["CVE-2024-1234"],
                    "target_urls": ["http://example.com"],
                },
            )

        assert response.status_code == 201
        data = response.json()
        assert data["status"] == "started"
        assert data["flow_id"] == 12345

    def test_successful_run_with_context(self, client):
        """Test successful run with context."""
        mock_result = MicroPentestResult(
            status="started",
            flow_id=99999,
            cve_ids=["CVE-2024-1234"],
            target_urls=["http://example.com"],
            message="Test started",
        )

        with patch(
            "apps.api.micro_pentest_router.run_micro_pentest",
            new_callable=AsyncMock,
            return_value=mock_result,
        ):
            response = client.post(
                "/api/v1/micro-pentest/run",
                json={
                    "cve_ids": ["CVE-2024-1234"],
                    "target_urls": ["http://example.com"],
                    "context": {"environment": "staging"},
                },
            )

        assert response.status_code == 201

    def test_pentagi_error(self, client):
        """Test handling of PentAGI error."""
        mock_result = MicroPentestResult(
            status="error",
            error="PentAGI service unavailable",
        )

        with patch(
            "apps.api.micro_pentest_router.run_micro_pentest",
            new_callable=AsyncMock,
            return_value=mock_result,
        ):
            response = client.post(
                "/api/v1/micro-pentest/run",
                json={
                    "cve_ids": ["CVE-2024-1234"],
                    "target_urls": ["http://example.com"],
                },
            )

        assert response.status_code == 502
        assert "PentAGI service unavailable" in response.json()["detail"]

    def test_pentagi_error_no_message(self, client):
        """Test handling of PentAGI error without error message."""
        mock_result = MicroPentestResult(
            status="error",
            error=None,
        )

        with patch(
            "apps.api.micro_pentest_router.run_micro_pentest",
            new_callable=AsyncMock,
            return_value=mock_result,
        ):
            response = client.post(
                "/api/v1/micro-pentest/run",
                json={
                    "cve_ids": ["CVE-2024-1234"],
                    "target_urls": ["http://example.com"],
                },
            )

        assert response.status_code == 502
        assert "Failed to start micro penetration test" in response.json()["detail"]


class TestGetPentestStatusEndpoint:
    """Tests for GET /api/v1/micro-pentest/status/{flow_id} endpoint."""

    def test_successful_status(self, client):
        """Test successful status retrieval."""
        mock_status = MicroPentestStatus(
            flow_id=123,
            status="running",
            progress=50,
            tasks=[{"id": 1, "name": "scan"}],
        )

        with patch(
            "apps.api.micro_pentest_router.get_micro_pentest_status",
            new_callable=AsyncMock,
            return_value=mock_status,
        ):
            response = client.get("/api/v1/micro-pentest/status/123")

        assert response.status_code == 200
        data = response.json()
        assert data["flow_id"] == 123
        assert data["status"] == "running"
        assert data["progress"] == 50

    def test_status_error(self, client):
        """Test handling of status error."""
        mock_status = MicroPentestStatus(
            flow_id=999,
            status="error",
            error="Flow not found",
        )

        with patch(
            "apps.api.micro_pentest_router.get_micro_pentest_status",
            new_callable=AsyncMock,
            return_value=mock_status,
        ):
            response = client.get("/api/v1/micro-pentest/status/999")

        assert response.status_code == 502
        assert "Flow not found" in response.json()["detail"]

    def test_status_error_no_message(self, client):
        """Test handling of status error without error message."""
        mock_status = MicroPentestStatus(
            flow_id=999,
            status="error",
            error=None,
        )

        with patch(
            "apps.api.micro_pentest_router.get_micro_pentest_status",
            new_callable=AsyncMock,
            return_value=mock_status,
        ):
            response = client.get("/api/v1/micro-pentest/status/999")

        assert response.status_code == 502
        assert "Failed to get flow status" in response.json()["detail"]


class TestBatchPentestsEndpoint:
    """Tests for POST /api/v1/micro-pentest/batch endpoint."""

    def test_empty_configs(self, client):
        """Test validation error when test_configs is empty."""
        response = client.post(
            "/api/v1/micro-pentest/batch",
            json={"test_configs": []},
        )
        assert response.status_code == 400
        assert (
            "At least one test configuration is required" in response.json()["detail"]
        )

    def test_successful_batch(self, client):
        """Test successful batch execution."""
        mock_result = {
            "status": "completed",
            "total": 2,
            "successful": 2,
            "failed": 0,
            "results": [
                {"status": "started", "flow_id": 1},
                {"status": "started", "flow_id": 2},
            ],
        }

        with patch(
            "apps.api.micro_pentest_router.run_batch_micro_pentests",
            new_callable=AsyncMock,
            return_value=mock_result,
        ):
            response = client.post(
                "/api/v1/micro-pentest/batch",
                json={
                    "test_configs": [
                        {
                            "cve_ids": ["CVE-2024-1234"],
                            "target_urls": ["http://example.com"],
                        },
                        {
                            "cve_ids": ["CVE-2024-5678"],
                            "target_urls": ["http://test.com"],
                        },
                    ]
                },
            )

        assert response.status_code == 201
        data = response.json()
        assert data["status"] == "completed"
        assert data["total"] == 2
        assert data["successful"] == 2

    def test_batch_with_context(self, client):
        """Test batch with context in configs."""
        mock_result = {
            "status": "completed",
            "total": 1,
            "successful": 1,
            "failed": 0,
            "results": [{"status": "started", "flow_id": 1}],
        }

        with patch(
            "apps.api.micro_pentest_router.run_batch_micro_pentests",
            new_callable=AsyncMock,
            return_value=mock_result,
        ):
            response = client.post(
                "/api/v1/micro-pentest/batch",
                json={
                    "test_configs": [
                        {
                            "cve_ids": ["CVE-2024-1234"],
                            "target_urls": ["http://example.com"],
                            "context": {"env": "test"},
                        },
                    ]
                },
            )

        assert response.status_code == 201

    def test_batch_error_all_failed(self, client):
        """Test batch error when all tests fail."""
        mock_result = {
            "status": "error",
            "total": 0,
            "successful": 0,
            "failed": 0,
            "error": "All tests failed to start",
        }

        with patch(
            "apps.api.micro_pentest_router.run_batch_micro_pentests",
            new_callable=AsyncMock,
            return_value=mock_result,
        ):
            response = client.post(
                "/api/v1/micro-pentest/batch",
                json={
                    "test_configs": [
                        {
                            "cve_ids": ["CVE-2024-1234"],
                            "target_urls": ["http://example.com"],
                        },
                    ]
                },
            )

        assert response.status_code == 400
        assert "All tests failed to start" in response.json()["detail"]

    def test_batch_error_no_message(self, client):
        """Test batch error without error message."""
        mock_result = {
            "status": "error",
            "total": 0,
            "successful": 0,
            "failed": 0,
        }

        with patch(
            "apps.api.micro_pentest_router.run_batch_micro_pentests",
            new_callable=AsyncMock,
            return_value=mock_result,
        ):
            response = client.post(
                "/api/v1/micro-pentest/batch",
                json={
                    "test_configs": [
                        {
                            "cve_ids": ["CVE-2024-1234"],
                            "target_urls": ["http://example.com"],
                        },
                    ]
                },
            )

        assert response.status_code == 400
        assert "Batch test failed" in response.json()["detail"]

    def test_batch_partial_success(self, client):
        """Test batch with partial success (some tests succeed, some fail)."""
        mock_result = {
            "status": "completed",
            "total": 2,
            "successful": 1,
            "failed": 1,
            "results": [
                {"status": "started", "flow_id": 1},
                {"status": "error", "error": "Failed"},
            ],
        }

        with patch(
            "apps.api.micro_pentest_router.run_batch_micro_pentests",
            new_callable=AsyncMock,
            return_value=mock_result,
        ):
            response = client.post(
                "/api/v1/micro-pentest/batch",
                json={
                    "test_configs": [
                        {
                            "cve_ids": ["CVE-2024-1234"],
                            "target_urls": ["http://example.com"],
                        },
                        {
                            "cve_ids": ["CVE-2024-5678"],
                            "target_urls": ["http://test.com"],
                        },
                    ]
                },
            )

        assert response.status_code == 201
        data = response.json()
        assert data["status"] == "completed"
        assert data["successful"] == 1
        assert data["failed"] == 1
