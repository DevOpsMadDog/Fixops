"""Example usage of Enterprise Micro Penetration Testing Engine."""

import asyncio
import json
from datetime import datetime

from fixops_enterprise.src.services.micro_pentest_engine import (
    AttackSurface,
    AttackVector,
    ComplianceFramework,
    MicroPentestEngine,
    MicroScanConfig,
    RiskLevel,
    ScanMode,
    ThreatCategory,
    ThreatModel,
)


async def example_api_security_scan():
    """Example: API Security Assessment."""
    print("=" * 80)
    print("Example 1: API Security Assessment")
    print("=" * 80)
    
    engine = MicroPentestEngine()
    
    # Define attack surface
    attack_surface = AttackSurface(
        name="E-Commerce API",
        target_url="https://api.ecommerce.example.com",
        target_type="api",
        endpoints=[
            "/api/v1/products",
            "/api/v1/cart",
            "/api/v1/checkout",
            "/api/v1/users",
            "/api/v1/auth/login",
        ],
        authentication_required=True,
        authentication_type="jwt",
        headers={
            "Content-Type": "application/json",
            "User-Agent": "FixOps-Pentest/1.0",
        },
        technologies=["Node.js", "Express", "PostgreSQL"],
        environment="staging",
    )
    
    # Define threat model
    threat_model = ThreatModel(
        name="OWASP API Security Top 10",
        description="Comprehensive API security testing",
        categories=[
            ThreatCategory.INITIAL_ACCESS,
            ThreatCategory.CREDENTIAL_ACCESS,
        ],
        attack_vectors=[
            AttackVector.SQL_INJECTION,
            AttackVector.AUTHENTICATION_BYPASS,
            AttackVector.API_ABUSE,
        ],
        mitre_techniques=["T1190", "T1078"],
        owasp_categories=["A03:2021-Injection", "A07:2021-Authentication Failures"],
        priority=9,
        compliance_frameworks=[
            ComplianceFramework.OWASP_TOP_10,
            ComplianceFramework.SOC2,
        ],
    )
    
    # Create scan configuration
    config = MicroScanConfig(
        name="E-Commerce API Security Scan",
        attack_surface=attack_surface,
        threat_model=threat_model,
        scan_mode=ScanMode.ACTIVE,
        timeout_seconds=300,
        rate_limit_rps=10,
        stop_on_critical=True,
        include_proof_of_concept=True,
        tenant_id="acme-corp",
        organization_id="eng-team",
        created_by="security-engineer",
        tags=["api", "ecommerce", "staging"],
    )
    
    # Create and execute scan
    print("\nCreating scan...")
    result = await engine.create_micro_scan(config, "security-engineer")
    print(f"Scan created: {result.scan_id}")
    
    print("\nExecuting scan...")
    result = await engine.execute_micro_scan(result.scan_id, "security-engineer")
    
    # Display results
    print(f"\n✓ Scan completed in {result.execution_time_seconds:.2f} seconds")
    print(f"\nSummary:")
    print(f"  Total findings: {result.summary['total_findings']}")
    print(f"  Critical: {result.summary['findings_by_risk'].get('critical', 0)}")
    print(f"  High: {result.summary['findings_by_risk'].get('high', 0)}")
    print(f"  Medium: {result.summary['findings_by_risk'].get('medium', 0)}")
    print(f"  Low: {result.summary['findings_by_risk'].get('low', 0)}")
    
    print(f"\nCompliance Status:")
    for framework, status in result.compliance_status.items():
        status_icon = "✓" if status else "✗"
        print(f"  {status_icon} {framework.value.upper()}: {'Compliant' if status else 'Non-compliant'}")
    
    print(f"\nTop Findings:")
    for i, finding in enumerate(result.findings[:5], 1):
        print(f"\n  {i}. [{finding.risk_level.value.upper()}] {finding.title}")
        print(f"     Endpoint: {finding.affected_endpoint}")
        print(f"     CVSS: {finding.cvss_score}")
        print(f"     Remediation: {finding.remediation}")


async def example_web_app_scan():
    """Example: Web Application Security Test."""
    print("\n\n" + "=" * 80)
    print("Example 2: Web Application Security Test")
    print("=" * 80)
    
    engine = MicroPentestEngine()
    
    attack_surface = AttackSurface(
        name="Admin Dashboard",
        target_url="https://admin.example.com",
        target_type="web_app",
        endpoints=["/login", "/dashboard", "/users/manage", "/settings"],
        authentication_required=True,
        authentication_type="session",
        technologies=["React", "Django", "MySQL"],
        environment="staging",
    )
    
    threat_model = ThreatModel(
        name="Web Application Security",
        description="OWASP Top 10 web security testing",
        categories=[
            ThreatCategory.INITIAL_ACCESS,
            ThreatCategory.PRIVILEGE_ESCALATION,
        ],
        attack_vectors=[
            AttackVector.XSS,
            AttackVector.CSRF,
            AttackVector.SQL_INJECTION,
            AttackVector.AUTHENTICATION_BYPASS,
        ],
        priority=10,
        compliance_frameworks=[ComplianceFramework.OWASP_TOP_10],
    )
    
    config = MicroScanConfig(
        name="Admin Portal Security Assessment",
        attack_surface=attack_surface,
        threat_model=threat_model,
        scan_mode=ScanMode.ACTIVE,
        tenant_id="acme-corp",
        organization_id="eng-team",
        created_by="security-engineer",
        tags=["web-app", "admin", "critical"],
    )
    
    print("\nCreating and executing scan...")
    result = await engine.create_micro_scan(config, "security-engineer")
    result = await engine.execute_micro_scan(result.scan_id, "security-engineer")
    
    print(f"\n✓ Scan completed: {len(result.findings)} findings")
    print(f"  Attack paths identified: {len(result.attack_paths)}")


async def example_compliance_scan():
    """Example: Compliance-Focused Security Scan."""
    print("\n\n" + "=" * 80)
    print("Example 3: SOC2 Compliance Validation")
    print("=" * 80)
    
    engine = MicroPentestEngine()
    
    attack_surface = AttackSurface(
        name="Customer Data API",
        target_url="https://api.customer.example.com",
        target_type="api",
        endpoints=["/api/v1/customers", "/api/v1/orders", "/api/v1/billing"],
        authentication_required=True,
        authentication_type="oauth2",
        technologies=["Python", "FastAPI", "PostgreSQL"],
        environment="production",
        metadata={"data_classification": "pii", "compliance_scope": "soc2_type2"},
    )
    
    threat_model = ThreatModel(
        name="SOC2 Security Controls Validation",
        description="Validate SOC2 security control effectiveness",
        categories=[
            ThreatCategory.INITIAL_ACCESS,
            ThreatCategory.CREDENTIAL_ACCESS,
            ThreatCategory.COLLECTION,
        ],
        attack_vectors=[
            AttackVector.AUTHENTICATION_BYPASS,
            AttackVector.AUTHORIZATION_BYPASS,
            AttackVector.API_ABUSE,
        ],
        priority=10,
        compliance_frameworks=[
            ComplianceFramework.SOC2,
            ComplianceFramework.ISO27001,
        ],
    )
    
    config = MicroScanConfig(
        name="SOC2 Compliance Scan",
        attack_surface=attack_surface,
        threat_model=threat_model,
        scan_mode=ScanMode.PASSIVE,  # Use passive for production
        tenant_id="acme-corp",
        organization_id="compliance-team",
        created_by="compliance-officer",
        tags=["compliance", "soc2", "production"],
    )
    
    print("\nRunning compliance validation...")
    result = await engine.create_micro_scan(config, "compliance-officer")
    result = await engine.execute_micro_scan(result.scan_id, "compliance-officer")
    
    print(f"\n✓ Compliance validation completed")
    print(f"\nCompliance Status:")
    for framework, status in result.compliance_status.items():
        icon = "✓" if status else "✗"
        print(f"  {icon} {framework.value.upper()}: {'PASS' if status else 'FAIL'}")
    
    if not all(result.compliance_status.values()):
        print(f"\n⚠ Compliance violations found:")
        for finding in result.findings:
            if finding.compliance_violations:
                print(f"  - {finding.title}")
                for violation in finding.compliance_violations:
                    print(f"    Framework: {violation.value}")


async def example_audit_logs():
    """Example: Retrieve Audit Logs."""
    print("\n\n" + "=" * 80)
    print("Example 4: Audit Log Retrieval")
    print("=" * 80)
    
    engine = MicroPentestEngine()
    
    # First, create a few scans to generate audit logs
    for i in range(3):
        attack_surface = AttackSurface(
            name=f"Test API {i}",
            target_url=f"https://api-{i}.example.com",
            target_type="api",
            endpoints=["/api/test"],
            environment="test",
        )
        
        threat_model = ThreatModel(
            name=f"Test Threat Model {i}",
            description="Test",
            categories=[ThreatCategory.INITIAL_ACCESS],
            attack_vectors=[AttackVector.API_ABUSE],
            priority=5,
        )
        
        config = MicroScanConfig(
            name=f"Test Scan {i}",
            attack_surface=attack_surface,
            threat_model=threat_model,
            scan_mode=ScanMode.PASSIVE,
            tenant_id="acme-corp",
            organization_id="test-team",
            created_by="test-user",
        )
        
        await engine.create_micro_scan(config, "test-user")
    
    # Retrieve audit logs
    print("\nRetrieving audit logs...")
    audit_logs = await engine.get_audit_logs(
        tenant_id="acme-corp",
        organization_id="test-team",
        limit=10,
    )
    
    print(f"\nFound {len(audit_logs)} audit log entries:")
    for log in audit_logs:
        print(f"\n  Timestamp: {log.timestamp.isoformat()}")
        print(f"  Action: {log.action}")
        print(f"  User: {log.user_id}")
        print(f"  Resource: {log.resource_type}/{log.resource_id}")
        print(f"  Result: {log.result}")
        if log.details:
            print(f"  Details: {json.dumps(log.details, indent=4)}")


async def example_continuous_scanning():
    """Example: Continuous Security Scanning."""
    print("\n\n" + "=" * 80)
    print("Example 5: Continuous Security Scanning")
    print("=" * 80)
    
    engine = MicroPentestEngine()
    
    # Simulate continuous scanning
    endpoints = [
        "/api/v1/auth",
        "/api/v1/users",
        "/api/v1/products",
        "/api/v1/orders",
    ]
    
    print("\nRunning continuous security scans on multiple endpoints...")
    
    for endpoint in endpoints:
        attack_surface = AttackSurface(
            name=f"API Endpoint: {endpoint}",
            target_url="https://api.example.com",
            target_type="api",
            endpoints=[endpoint],
            authentication_required=True,
            authentication_type="jwt",
            environment="production",
        )
        
        threat_model = ThreatModel(
            name="Continuous Security Monitoring",
            description=f"Automated security testing for {endpoint}",
            categories=[ThreatCategory.INITIAL_ACCESS],
            attack_vectors=[
                AttackVector.SQL_INJECTION,
                AttackVector.API_ABUSE,
            ],
            priority=7,
        )
        
        config = MicroScanConfig(
            name=f"Continuous Scan: {endpoint}",
            attack_surface=attack_surface,
            threat_model=threat_model,
            scan_mode=ScanMode.PASSIVE,
            timeout_seconds=60,
            tenant_id="acme-corp",
            organization_id="devsecops",
            created_by="automation-bot",
            tags=["continuous", "automated", endpoint.replace("/", "-")],
        )
        
        print(f"\n  Scanning {endpoint}...", end=" ")
        result = await engine.create_micro_scan(config, "automation-bot")
        result = await engine.execute_micro_scan(result.scan_id, "automation-bot")
        
        critical_count = result.summary["findings_by_risk"].get("critical", 0)
        high_count = result.summary["findings_by_risk"].get("high", 0)
        
        if critical_count > 0 or high_count > 0:
            print(f"⚠ ALERT: {critical_count} critical, {high_count} high findings")
        else:
            print("✓ No critical issues")
    
    print("\n✓ Continuous scanning completed")


async def example_attack_path_analysis():
    """Example: Attack Path Analysis."""
    print("\n\n" + "=" * 80)
    print("Example 6: Attack Path Analysis")
    print("=" * 80)
    
    engine = MicroPentestEngine()
    
    attack_surface = AttackSurface(
        name="Multi-Tier Application",
        target_url="https://app.example.com",
        target_type="web_app",
        endpoints=[
            "/api/public",
            "/api/auth",
            "/api/user",
            "/api/admin",
        ],
        authentication_required=True,
        authentication_type="jwt",
        environment="staging",
    )
    
    threat_model = ThreatModel(
        name="Full Kill Chain Analysis",
        description="Analyze complete attack chains from initial access to impact",
        categories=[
            ThreatCategory.INITIAL_ACCESS,
            ThreatCategory.PRIVILEGE_ESCALATION,
            ThreatCategory.LATERAL_MOVEMENT,
            ThreatCategory.IMPACT,
        ],
        attack_vectors=[
            AttackVector.SQL_INJECTION,
            AttackVector.AUTHENTICATION_BYPASS,
            AttackVector.AUTHORIZATION_BYPASS,
            AttackVector.COMMAND_INJECTION,
        ],
        priority=10,
    )
    
    config = MicroScanConfig(
        name="Attack Path Analysis",
        attack_surface=attack_surface,
        threat_model=threat_model,
        scan_mode=ScanMode.ACTIVE,
        tenant_id="acme-corp",
        organization_id="red-team",
        created_by="penetration-tester",
        tags=["attack-path", "red-team"],
    )
    
    print("\nAnalyzing attack paths...")
    result = await engine.create_micro_scan(config, "penetration-tester")
    result = await engine.execute_micro_scan(result.scan_id, "penetration-tester")
    
    print(f"\n✓ Analysis completed")
    print(f"  Total attack paths identified: {len(result.attack_paths)}")
    
    if result.attack_paths:
        print(f"\nAttack Paths:")
        for i, path in enumerate(result.attack_paths, 1):
            print(f"\n  Path {i}: {path['name']}")
            print(f"  Risk Level: {path['risk_level']}")
            print(f"  Likelihood: {path['likelihood']}")
            print(f"  Steps:")
            for step in path['steps']:
                print(f"    - {step['stage']}: {len(step['findings'])} findings")


async def main():
    """Run all examples."""
    print("\n")
    print("╔" + "=" * 78 + "╗")
    print("║" + " " * 78 + "║")
    print("║" + " " * 15 + "Enterprise Micro Penetration Testing Engine" + " " * 20 + "║")
    print("║" + " " * 30 + "Examples" + " " * 40 + "║")
    print("║" + " " * 78 + "║")
    print("╚" + "=" * 78 + "╝")
    
    try:
        await example_api_security_scan()
        await example_web_app_scan()
        await example_compliance_scan()
        await example_audit_logs()
        await example_continuous_scanning()
        await example_attack_path_analysis()
        
        print("\n\n" + "=" * 80)
        print("All examples completed successfully!")
        print("=" * 80)
        print("\nFor more information, see:")
        print("  - Documentation: /docs/MICRO_PENTEST_README.md")
        print("  - Examples: /docs/MICRO_PENTEST_EXAMPLES.md")
        print("  - API Docs: http://localhost:8000/api/v1/docs")
        print("\n")
        
    except Exception as e:
        print(f"\n\n❌ Error running examples: {e}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    asyncio.run(main())
