package fixops

import rego.v1

# OPA requires an explicit default â€” without it the decision is *undefined*
# rather than *false* when no rule matches, which most consumers misinterpret.
default allow := false

# Allow if no critical vulnerabilities
allow if {
    count(input.vulnerabilities) == 0
}

allow if {
    count([v | v := input.vulnerabilities[_]; v.severity == "CRITICAL"]) == 0
}

# Allow if critical vulns have patches available
allow if {
    critical_vulns := [v | v := input.vulnerabilities[_]; v.severity == "CRITICAL"]
    count(critical_vulns) > 0
    every vuln in critical_vulns {
        vuln.fix_available == true
    }
}
