# Micro Penetration Test Integration Guide

## Overview

This document describes the micro penetration test feature that allows users to select multiple CVEs from the risk graph and run targeted penetration tests using PentAGI.

## Features

### 1. Multi-Select CVEs

- **Single Click**: Selects a single CVE and clears other selections
- **Ctrl/Cmd + Click**: Adds/removes CVEs from selection
- **Visual Feedback**: Selected CVEs are highlighted with a purple border
- **Selection Counter**: Shows number of selected CVEs in the stats panel

### 2. Context Menu

- **Right-Click**: Opens context menu when CVEs are selected
- **Run Micro Pen Tests**: Initiates penetration testing for selected CVEs
- **Status Display**: Shows running status and flow ID

### 3. PentAGI Integration

- **Automatic Flow Creation**: Creates PentAGI flow for each micro pen test
- **Target Discovery**: Automatically discovers target URLs from connected services/components
- **Status Polling**: Polls PentAGI for test status updates
- **Error Handling**: Graceful error handling with user feedback

## Usage

### Step 1: Select CVEs

1. Navigate to the Risk Graph page
2. Click on CVE nodes to select them
3. Use Ctrl/Cmd + Click to select multiple CVEs
4. Selected CVEs will be highlighted with a purple border

### Step 2: Run Micro Pen Tests

1. Right-click on any selected CVE
2. Click "Run Micro Pen Tests" from the context menu
3. The system will:
   - Extract target URLs from connected services/components
   - Create a PentAGI flow for testing
   - Start the penetration test

### Step 3: Monitor Status

1. A status notification appears in the bottom-right corner
2. Shows flow ID, status, and progress
3. Status updates automatically every 5 seconds
4. Notification closes when test completes or fails

## API Endpoints

### POST /api/v1/micro-pentest/run

Starts a micro penetration test for selected CVEs.

**Request Body:**
```json
{
  "cve_ids": ["CVE-2024-1234", "CVE-2024-5678"],
  "target_urls": ["https://example.com", "https://api.example.com"],
  "context": {
    "source": "risk_graph",
    "selected_count": 2
  }
}
```

**Response:**
```json
{
  "status": "started",
  "flow_id": 12345,
  "cve_ids": ["CVE-2024-1234", "CVE-2024-5678"],
  "target_urls": ["https://example.com"],
  "message": "Micro penetration test started for 2 CVEs"
}
```

### GET /api/v1/micro-pentest/status/{flow_id}

Gets the status of a running micro penetration test.

**Response:**
```json
{
  "flow_id": 12345,
  "status": "running",
  "progress": 45,
  "tasks": [...]
}
```

### POST /api/v1/micro-pentest/batch

Runs multiple micro penetration tests in parallel.

**Request Body:**
```json
{
  "test_configs": [
    {
      "cve_ids": ["CVE-2024-1234"],
      "target_urls": ["https://example.com"]
    },
    {
      "cve_ids": ["CVE-2024-5678"],
      "target_urls": ["https://api.example.com"]
    }
  ]
}
```

## Configuration

### PentAGI URL

The micro pentest API connects to PentAGI at:
- Default: `http://pentagi:8443`
- Configurable via environment variable: `PENTAGI_BASE_URL`

### Timeout Settings

- **Request Timeout**: 300 seconds (5 minutes)
- **Status Polling**: Every 5 seconds
- **Auto-Close**: After 5 minutes

## Integration Flow

```
User selects CVEs → Right-click → Run Micro Pen Tests
    ↓
Extract target URLs from graph
    ↓
Call /api/v1/micro-pentest/run
    ↓
Create PentAGI flow
    ↓
Start penetration test
    ↓
Poll status every 5 seconds
    ↓
Display results in notification
```

## Error Handling

- **No CVEs Selected**: Alert shown to user
- **No Target URLs**: Default URL used (https://example.com)
- **PentAGI Unavailable**: Error notification with details
- **Timeout**: Status polling stops after 5 minutes

## Future Enhancements

- [ ] Real-time progress updates via WebSocket
- [ ] Detailed test results view
- [ ] Test history and reports
- [ ] Custom test configurations
- [ ] Integration with FixOps decision engine for results analysis
